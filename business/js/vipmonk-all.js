Ext.define("VIP.widget.Link",{extend:Ext.Component,alias:["widget.link"],requires:[],height:30,padding:"6 20 6 20",baseCls:"x-link",initComponent:function(){if(this.icon){this.html='<img src="'+this.icon+'"><span>'+this.text+"</span>"}else{this.html="<span>"+this.text+"</span>"}this.callParent(arguments);this.on("render",function(){this.getEl().on("mouseover",function(){this.addCls("x-boundlist-item-over")},this);this.getEl().on("mouseout",function(){this.removeCls("x-boundlist-item-over")},this);if(this.handler){this.getEl().on("click",function(){this.handler.call(this,this)},this)}},this)}});Ext.define("VIP.welcome.Summary",{extend:Ext.panel.Panel,alias:["widget.welcomesummary"],requires:[],title:"信息汇总",iconCls:"icon-member-welcome",layout:{type:"table",columns:2},defaults:{margin:10},items:[],createDockedItems:function(a){var b=this;var c=[];return c},initComponent:function(){this.callParent(arguments)}});Ext.define("VIP.west.Welcome",{extend:Ext.panel.Panel,alias:["widget.vipwestwelcome"],title:"欢迎",collapsible:false,iconCls:"west-welcome",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text,d.itemId)};var a=[{text:"信息汇总",icon:"images/star.png",itemId:"welcome",handler:b}];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(b,c){var a=this;vip.viewport.main.removeAll();a.up().changeLink(c);if(b=="信息汇总"){vip.viewport.main.add({xtype:"welcomesummary"})}}});Ext.define("VIP.member.MemberWithdraw",{extend:Ext.form.Panel,alias:["widget.memberwithdraw","VIP.member.DetailMain"],userId:null,icon:"images/withdraw.png",layout:"border",createView:function(){var d=this;var a="font-size:11pt;margin-top:12px";var c="font-size:14pt;background-image:none;border-width:0px 0px 1px 0px";var b=[{xtype:"panel",region:"center",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"form",title:"取款信息",icon:"images/withdraw.png",width:300,height:250,bodyPadding:10,layout:{type:"vbox"},fieldDefaults:{height:30,border:false,labelStyle:a,fieldStyle:c,labelAlign:"right",labelWidth:110,width:340,hideTrigger:true},items:[{xtype:"fieldcontainer",fieldLabel:"取款金额",layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",fieldStyle:c+";color:green",width:100,mouseWheelEnabled:false,allowBlank:false,value:0,name:"amount",itemId:"amount",selectOnFocus:true,minValue:0,negativeText:"最小值为0,最大值为100000",maxValue:d.currentDeposit,listeners:{change:{fn:function(g,e,f){if(parseFloat(g.getValue())>parseFloat(d.currentDeposit)){Ext.Msg.error("余额不足",function(){g.setValue(d.currentDeposit);g.focus(true,100)})}},delay:200},specialKey:{fn:function(g,e,f){if(e.keyCode==13){d.down("#note").focus(true)}},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"textareafield",name:"note",itemId:"note",height:80,width:235,labelWidth:40,maxLength:100,maxLengthText:"不可超过100字符",hideEmptyLabel:false,fieldStyle:"font-size:11pt",emptyText:"备注",listeners:{specialKey:function(f,e){if(e.keyCode==13){d.specialKeyListener(f,e)}},change:function(h,f){var g=h.getValue().length;var e=100-g;if(e>0&&e!=100){d.down("#lengthInfo").setText("还可输入"+e+"个字符")}else{if(e==0||e==100){d.down("#lengthInfo").setText("")}else{d.down("#lengthInfo").setText("已经超出"+(-e)+"个字符")}}}}},{xtype:"label",margin:"0 100",style:"color:red",itemId:"lengthInfo",text:""},{xtype:"container",border:false,width:280,margin:"15 0 0 0",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"button",itemId:"save",text:"确定",icon:"images/update.png",scale:"large",width:190,height:60,padding:10,cls:"big-button",handler:function(e){d.withdrawSave()}}]}]}]},{xtype:"detailmain",title:"会员信息",icon:"images/basic_info.png",region:"south",collapsed:false,collapsible:true,titleCollapse:true,split:true,height:400,userId:this.userId}];return b},load:function(a){var b=this;if(a){this.userId=a}b.removeAll(true);WithdrawAction.canWithdraw(function(c){if(c.success){MemberAction.getMemberById(b.userId,function(d){var e=d.data;b.userAccountName=e.userAccountName;b.currentDeposit=e.currentDeposit;b.add(b.createView());b.down("#amount").focus(true,100)})}else{Ext.Msg.error(c.message)}})},withdrawSave:function(){var c=this.getForm();var b=this;if(c.isValid()){var a=this.getValues();if(a.amount==0){Ext.Msg.error("请输入取款金额",function(){b.down("#amount").focus(true,100)})}else{Ext.Msg.confirm("确认","确认要从卡 ["+b.userAccountName+"] 取现 ["+a.amount+"] 元吗?",function(d){if(d=="yes"){WithdrawAction.add(b.userId,a,function(e){if(e.success){Ext.Msg.info("取款成功.",function(){b.doPrint(e.data._id);b.close()})}else{Ext.Msg.error(e.message,function(){})}})}})}}},doPrint:function(a){Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/withdraw.jsp?id="+a}).show()},specialKeyListener:function(e,c){var a=this.getForm().getFields().items;var b=a.indexOf(e);if(c.keyCode==13){b++;var d=a[b];while(d.readOnly||d.isDisabled()||!d.focus){b++;d=a[b]}d.focus(true,100)}},memberSearch:function(){var a=this;Ext.create("VIP.search.SearchMember",{onRecordSelect:{fn:function(b){a.load(b)}}}).show()},initComponent:function(){this.callParent(arguments);this.memberSearch()}});Ext.define("VIP.store.BaseStore",{extend:Ext.data.Store,constructor:function(a){this.callParent([a]);this.on("load",function(){var b=this.getProxy().getReader().rawData;if(b.message){Ext.MessageBox.show({title:b.success?"信息":"错误",msg:b.message,buttons:Ext.MessageBox.OK,icon:b.success?Ext.MessageBox.INFO:Ext.MessageBox.ERROR,fn:function(d,c){if(b.errorType==0){document.location.href="http://localhost:8080/vipmonk/business/index.html"}}})}},this)}});Ext.define("VIP.member.model.Member",{extend:Ext.data.Model,fields:[{name:"userId",type:"string"},{name:"userScreenName",type:"string"},{name:"userAccountName",type:"string"},{name:"totalConsume",type:"string"},{name:"vipCardTypeName",type:"string"},{name:"membershipTypeId",type:"string"},{name:"discountRate",type:"string"},{name:"moneyBackRate",type:"string"},{name:"currentDeposit",type:"string"},{name:"phoneNumber",type:"string"}]});Ext.define("VIP.member.store.Member",{extend:VIP.store.BaseStore,model:"VIP.member.model.Member",remoteSort:true,pageSize:50,sorters:[{property:"lastUpdateTime",direction:"DESC"}],proxy:{type:"direct",directFn:"MemberAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.member.MemberGrid",{extend:Ext.grid.Panel,alias:["widget.membergrid"],margin:5,columns:[{xtype:"rownumberer",width:50,align:"center",text:"序列",flex:1,sortable:false},{text:"会员昵称",dataIndex:"userScreenName",flex:2},{text:"会员手机",dataIndex:"phoneNumber",flex:2},{text:"级别",dataIndex:"vipCardTypeName",flex:1}],createDockedItems:function(a){var b=[{xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,displayMsg:"",emptyMsg:""}];return b},initComponent:function(){var a=Ext.create("VIP.member.store.Member");Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.on("selectionchange",this.onSelectChange.fn,this.onSelectChange.scope);a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.callParent(arguments)},refresh:function(){this.getStore().reload()},doQuery:function(a){var c=this.getStore().getProxy().extraParams;var b=this;if(!c){c={};this.getStore().getProxy().extraParams=c}if(a.userScreenName!=""){c.accountName=a.userScreenName}else{c.accountName=undefined}if(a.telephone!=""){c.telephone=a.telephone}else{c.telephone=undefined}this.getStore().loadPage(1)}});Ext.define("VIP.member.MemberInfo",{extend:Ext.panel.Panel,alias:["widget.vipmembermemberinfo"],iconCls:"icon-member-info",layout:{type:"hbox",align:"stretch"},defaults:{border:false},createView:function(){var b=this;var a=[{xtype:"panel",width:"30%",layout:"anchor",items:[{xtype:"form",width:"100%",height:130,layout:"fit",border:false,items:[{xtype:"fieldset",title:"查询条件",margin:5,defaults:{xtype:"textfield",width:300},layout:{type:"vbox",align:"stretch"},items:[{fieldLabel:"会员昵称",emptyText:"会员昵称",name:"userScreenName",itemId:"userScreenName",listeners:{specialKey:{fn:function(i,f,g){if(f.keyCode==13){var c=this.up("vipmembermemberinfo");var e=c.down("membergrid");var h=c.down("form").getForm();var d=h.getValues();e.getSelectionModel().deselectAll();e.doQuery(d)}},delay:200}}},{fieldLabel:"会员手机号",emptyText:"会员手机号",name:"telephone",itemId:"telephone",regex:/^1[3|4|5|8][0-9]{9}$/,regexText:"无效的手机号码",listeners:{specialKey:{fn:function(i,f,g){if(f.keyCode==13){var c=this.up("vipmembermemberinfo");var e=c.down("membergrid");var h=c.down("form").getForm();var d=h.getValues();e.getSelectionModel().deselectAll();e.doQuery(d)}},delay:200}}},{xtype:"button",icon:"images/search.png",width:120,margin:"5 0 0 0",scale:"medium",text:"查询",handler:function(f){var c=this.up("vipmembermemberinfo");var e=c.down("membergrid");var g=c.down("form").getForm();var d=g.getValues();e.getSelectionModel().deselectAll();e.doQuery(d)}}]}]},{xtype:"membergrid",anchor:"100% -130",onSelectChange:{fn:b.onSelectChange,scope:b}}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView()});this.callParent(arguments)},onSelectChange:function(b,c,a){var e=this.down("detailmain");var d=this;if(e!=undefined){this.remove(e)}if(c.length!=0){d.setLoading("查询中...");d.down("membergrid").suspendEvents();setTimeout(function(){var f=c[0].data;e=Ext.create("VIP.member.DetailMain",{width:"70%",title:"["+f.userScreenName+"] ",userId:f.userId,marking:"1",onLoad:{fn:function(){d.setLoading(false);d.down("membergrid").resumeEvents()},scope:d},onSave:{fn:function(){var g=this.down("membergrid");g.refresh()},scope:d}});d.add(e)},800)}}});Ext.define("VIP.common.PrintWindow",{extend:Ext.window.Window,alias:["widget.printwindow"],layout:"fit",width:360,height:480,url:null,buttonAlign:"center",createView:function(){var b=this;var a=[{xtype:"panel",border:false,html:'<iframe frameborder="0" scrolling="auto" src="'+b.url+'"></iframe>',listeners:{resize:function(c,f,e){var d=c.up("printwindow").iframe;d.setWidth(c.getWidth());d.setHeight(c.getHeight()-27)},afterrender:function(c){var d=c.getEl().select("iframe").first();b.iframe=d;d.dom.onload=d.dom.onreadystatechange=function(){if(!this.readyState||this.readyState=="complete"){b.down("#print").enable();b.down("#print").focus(true,100);b.down("#close").enable()}}}}}];return a},createButtons:function(){var b=this;var a=[{text:"打印",icon:"images/print.png",scale:"medium",itemId:"print",disabled:true,handler:function(c){b.print(c)}},{text:"关闭",icon:"images/cancel.png",scale:"medium",itemId:"close",disabled:true,handler:function(c){b.close()}}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)},print:function(a){a.disable();this.iframe.dom.contentWindow.focus();this.iframe.dom.contentWindow.print();a.enable()}});Ext.define("VIP.member.MemberDeposit",{extend:Ext.form.Panel,alias:["widget.memberdeposit"],icon:"images/deposit-16.png",userId:null,moneyBackRate:null,layout:"border",createView:function(){var d=this;var a="font-size:11pt;margin-top:12px";var c="font-size:14pt;background-image:none;border-width:0px 0px 1px 0px";var b=[{xtype:"panel",region:"center",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"form",title:"充值信息",iconCls:"icon-member-deposit",width:300,height:280,bodyPadding:10,layout:{type:"vbox"},fieldDefaults:{height:30,border:false,labelStyle:a,fieldStyle:c,labelAlign:"right",labelWidth:110,width:340,hideTrigger:true,selectOnFocus:true},items:[{xtype:"fieldcontainer",fieldLabel:"充值金额",layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",name:"realAmount",itemId:"realAmount",width:100,fieldStyle:c+";color:red",allowBlank:false,mouseWheelEnabled:false,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000",listeners:{change:{fn:function(h,f,g){if(h.getValue()==null||h.getValue()==0||h.getValue()=="e"){d.down("#rewardAmount").setValue(0);d.down("#realAmount").setValue(0)}else{var e=parseFloat(h.getValue())*(parseFloat(d.moneyBackRate))/100;d.down("#rewardAmount").setValue(e)}},delay:200},specialKey:{fn:function(g,e,f){if(e.keyCode==13){d.down("#rewardAmount").focus(true)}},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"fieldcontainer",fieldLabel:"赠送金额",layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",name:"rewardAmount",itemId:"rewardAmount",width:100,fieldStyle:c+";color:#FF9912",readOnly:true,mouseWheelEnabled:false,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){d.down("#note").focus(true)}},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"textareafield",name:"note",itemId:"note",height:80,width:235,maxLength:100,maxLengthText:"不可超过100字符",labelWidth:40,hideEmptyLabel:false,fieldStyle:"font-size:11pt",emptyText:"备注",listeners:{specialKey:function(f,e){if(e.keyCode==13){d.specialKeyListener(f,e)}},change:function(h,f){var g=h.getValue().length;var e=100-g;if(e>0&&e!=100){d.down("#lengthInfo").setText("还可输入"+e+"个字符")}else{if(e==0||e==100){d.down("#lengthInfo").setText("")}else{d.down("#lengthInfo").setText("已经超出"+(-e)+"个字符")}}}}},{xtype:"label",margin:"0 100",style:"color:red",itemId:"lengthInfo",text:""},{xtype:"container",border:false,width:280,margin:"15 0 0 0",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"button",itemId:"save",text:"确定",icon:"images/update.png",scale:"large",width:190,height:60,padding:10,cls:"big-button",handler:function(e){d.depositSave()}}]}]}]},{xtype:"detailmain",title:"会员信息",icon:"images/basic_info.png",region:"south",collapsed:false,collapsible:true,titleCollapse:true,split:true,height:400,userId:this.userId}];return b},load:function(a){var b=this;if(a){this.userId=a}this.removeAll(true);DepositAction.canDeposit(function(c){if(c.success){MemberAction.getMemberById(b.userId,function(d){var e=d.data;b.moneyBackRate=e.moneyBackRate;b.add(b.createView());b.down("#realAmount").focus(true,100)})}else{Ext.Msg.error(c.message)}})},memberSearch:function(){var a=this;Ext.create("VIP.search.SearchMember",{onRecordSelect:{fn:function(b){a.load(b)}}}).show()},initComponent:function(){this.callParent(arguments);this.memberSearch()},depositSave:function(){var c=this.getForm();var b=this;if(c.isValid()){var a=this.getValues();if(a.realAmount==0){Ext.Msg.error("请输入充值金额",function(){b.down("#realAmount").focus(true,100)})}else{Ext.Msg.confirm("确认","确认要存入 ["+a.realAmount+"] 元 并 赠送 ["+a.rewardAmount+"]元 吗?",function(d){if(d=="yes"){DepositAction.add(b.userId,a,function(e){if(e.success){Ext.Msg.info("充值成功.",function(){b.doPrint(e.data._id);b.close()})}else{Ext.Msg.error(e.message)}})}})}}},doPrint:function(b){var a=this;Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/deposit.jsp?id="+b}).show()},specialKeyListener:function(e,c){var a=this.getForm().getFields().items;var b=a.indexOf(e);if(c.keyCode==13){b++;var d=a[b];while(d.readOnly||d.isDisabled()||!d.focus){b++;d=a[b]}d.focus(true,100)}}});Ext.define("Option",{extend:Ext.data.Model,fields:[{name:"text",type:"string"},{name:"value",type:"string"}]});Ext.define("VIP.widget.field.ComboBox",{extend:Ext.form.field.ComboBox,alias:["widget.vcombo"],forceSelection:true,editable:false,queryMode:"local",displayField:"text",valueField:"value",triggerAction:"all",initComponent:function(){var a=this;this.addEvents("optionsready");if(a.options){a.store=Ext.create("Ext.data.Store",{fields:["text","value"],data:a.options});a.fireEvent("optionsready",a)}else{a.store=Ext.create("Ext.data.Store",{model:"Option",proxy:a.getProxy(),autoLoad:true});a.store.on("load",function(){if(a.originalValue!=undefined&&a.originalValue!=""){a.setValue(a.originalValue)}else{if(a.allowBlank===false&&a.store.getTotalCount()>0){}}a.fireEvent("optionsready",a)},a,{delay:200});if(!a.isDisabled()){a.store.on("beforeload",function(){this.setDisabled(true)},a);a.store.on("load",function(){this.setDisabled(false)},a)}}this.callParent()},refresh:function(){if(!this.store.isLoading()){this.store.setProxy(this.getProxy());this.store.load()}},setOptions:function(a){this.store.loadData(a,false)},getText:function(){var b=this.store.findExact("value",this.getValue());if(b!=-1){var a=this.store.getAt(b).data;return a.text}}});Ext.define("VIP.widget.field.CKEditor",{extend:Ext.form.field.TextArea,alias:["widget.ckeditorfield"],requires:[],ckfinderOpts:{filebrowserBrowseUrl:contextPath+"ckfinder/ckfinder.html",filebrowserImageBrowseUrl:contextPath+"ckfinder/ckfinder.html?type=Images",filebrowserFlashBrowseUrl:contextPath+"ckfinder/ckfinder.html?type=Flash",filebrowserUploadUrl:contextPath+"ckfinder/core/connector/java/connector.java?command=QuickUpload&type=Files",filebrowserImageUploadUrl:contextPath+"ckfinder/core/connector/java/connector.java?command=QuickUpload&type=Images",filebrowserFlashUploadUrl:contextPath+"ckfinder/core/connector/java/connector.java?command=QuickUpload&type=Flash",filebrowserWindowWidth:"720",filebrowserWindowHeight:"560"},listeners:{afterrender:function(a){if(typeof CKEDITOR!="undefined"){CKEDITOR.config.height=a.getHeight();var b=a.inputEl.dom.id;CKEDITOR.replace(b,this.ckfinderOpts);a.ckeditor=CKEDITOR.instances[b]}},destroy:function(a){a.ckeditor.destroy()}}});Ext.define("VIP.widget.form.Panel",{extend:Ext.form.Panel,alias:["widget.vipform"],initComponent:function(){this.callParent(arguments)},bindEnterKeyEvent:function(){var c=function(i,g){var e=this.getForm().getFields().items;var f=e.indexOf(i);if(g.keyCode==13){f++;var h=e[f];while(h.readOnly||h.isDisabled()||!h.focus){f++;h=e[f]}h.focus(true,100)}};var a=this.getForm().getFields().items;for(var b=0;b<a.length;b++){var d=a[b];if(d.readOnly||d.isDisabled()||d.xtype=="radio"||d.xtype=="textarea"){continue}else{d.on("specialKey",c,this)}}}});Ext.define("VIP.shopping.QuickConsume",{extend:VIP.widget.form.Panel,alias:["widget.quickconsume"],userId:null,discountRate:null,currentDeposit:null,hasPassword:null,icon:"images/consume-16.png",userPassword:null,layout:"border",type:false,createView:function(){var d=this;var a="font-size:11pt;margin-top:12px";var c="font-size:14pt;background-image:none;border-width:0px 0px 1px 0px";var b=[{xtype:"panel",region:"center",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"form",title:"订单信息",icon:"images/consume-16.png",width:515,height:370,bodyPadding:10,layout:{type:"table",columns:2},fieldDefaults:{height:30,border:false,labelStyle:a,fieldStyle:c,labelAlign:"right",width:240,hideTrigger:true,selectOnFocus:true},items:[{xtype:"fieldcontainer",fieldLabel:"消费金额",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",allowBlank:false,mouseWheelEnabled:false,hideTrigger:true,fieldStyle:c+";color:red",width:100,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000",itemId:"consumptionAmount",name:"consumptionAmount",listeners:{change:{fn:function(i,f,g){var h=parseFloat(i.getValue());if(h!=""&&h!=null&&h!=0){var e=h*(d.numSub(100,parseFloat(d.discountRate)))/100;d.down("#accountPayable").setValue(e);d.down("#discount").setValue(d.numSub(h,e));d.down("#cashPayment").clearInvalid();d.down("#cashPayment").setMinValue(0);d.down("#change").setValue(0)}else{d.down("#accountPayable").setValue(0);d.down("#discount").setValue(0);d.down("#memberPayment").setValue(0);d.down("#cashPayment").setValue(0);d.down("#change").setValue(0)}},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"textfield",fieldLabel:"内容",allowBlank:false,maxLength:10,maxLengthText:"不可超过10字符",name:"consumeSubject",itemId:"consumeSubject",value:"消费"},{xtype:"fieldcontainer",fieldLabel:"折扣",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",fieldStyle:c+";color:green",name:"discount",mouseWheelEnabled:false,itemId:"discount",readOnly:true,width:100,value:0,minValue:0,negativeText:"最小值为0,最大值为100000"},{xtype:"label",style:a,text:"元"}]},{xtype:"textarea",hideEmptyLabel:false,labelWidth:30,rowspan:6,height:205,emptyText:"备注",maxLength:100,maxLengthText:"不可超过100字符",fieldStyle:"font-size:11pt",itemId:"notes",name:"notes",listeners:{specialKey:function(f,e){if(e.keyCode==13){d.specialKeyListener(f,e)}},change:function(h,f){var g=h.getValue().length;var e=d.numSub(100,g);if(e>0&&e!=100){d.down("#lengthInfo").setText("还可输入"+e+"个字符")}else{if(e==0||e==100){d.down("#lengthInfo").setText("")}else{d.down("#lengthInfo").setText("已经超出"+(-e)+"个字符")}}}}},{xtype:"fieldcontainer",fieldLabel:"应付金额",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",fieldStyle:c+";color:red",width:100,allowBlank:false,mouseWheelEnabled:false,readOnly:true,value:0,itemId:"accountPayable",name:"accountPayable",minValue:0,negativeText:"最小值为0,最大值为100000",listeners:{change:{fn:function(i,f,g){var h=parseFloat(i.getValue());d.down("#memberPayment").suspendEvents();d.down("#cashPayment").suspendEvents();d.down("#change").suspendEvents();if(d.type==false||d.type==null||d.type==null){d.down("#cashPayment").setValue(h);d.down("#cashPayment").clearInvalid();d.down("#cashPayment").setMinValue(h);d.down("#change").setValue(0)}else{var e=parseFloat(d.currentDeposit);if(h>e){d.down("#memberPayment").setValue(e);d.down("#cashPayment").setValue(d.numSub(h,e));d.down("#cashPayment").clearInvalid();d.down("#memberPayment").setMaxValue(e);d.down("#cashPayment").setMinValue(d.numSub(h,e))}else{d.down("#memberPayment").setValue(h);d.down("#cashPayment").setValue(0);d.down("#memberPayment").setMaxValue(e)}}d.down("#memberPayment").resumeEvents();d.down("#cashPayment").resumeEvents();d.down("#change").resumeEvents()},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"fieldcontainer",fieldLabel:"卡内支付",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",itemId:"memberPayment",name:"memberPayment",width:100,allowBlank:false,mouseWheelEnabled:false,readOnly:true,value:0,minValue:0,negativeText:"最小值为0,最大值为100000",listeners:{change:{fn:function(j,g,h){var i=parseFloat(j.getValue());if(d.type==true){var f=parseFloat(d.down("#accountPayable").getValue());var e=parseFloat(d.down("#cashPayment").getValue());d.down("#cashPayment").suspendEvents();d.down("#change").suspendEvents();if(f>d.numAdd(i,e)){d.down("#cashPayment").clearInvalid();d.down("#cashPayment").setValue(d.numSub(f,i));d.down("#cashPayment").setMinValue(d.numSub(f,i))}else{if(f==d.numAdd(i,e)){d.down("#cashPayment").clearInvalid();d.down("#cashPayment").setValue(e);d.down("#cashPayment").setMinValue(e);d.down("#change").setValue(0)}else{if(f<i){d.down("#memberPayment").markInvalid("卡支付金额超出消费金额");d.down("#cashPayment").setValue(0);d.down("#cashPayment").clearInvalid();d.down("#cashPayment").setMinValue(0);d.down("#change").setValue(0)}else{d.down("#cashPayment").setValue(d.numSub(f,i));d.down("#change").setValue(0);d.down("#cashPayment").clearInvalid();d.down("#cashPayment").setMinValue(d.numSub(f,i))}}}d.down("#cashPayment").resumeEvents();d.down("#change").resumeEvents()}},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"fieldcontainer",fieldLabel:"现金支付",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",itemId:"cashPayment",name:"cashPayment",mouseWheelEnabled:false,width:100,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000",allowBlank:false,listeners:{change:{fn:function(k,h,i){var j=parseFloat(k.getValue());if(isNaN(j)){j=0}var g=parseFloat(d.down("#accountPayable").getValue());if(d.type==false||d.type==null){if(j>=g){d.down("#change").setValue(d.numSub(j,g))}else{if(j<g){d.down("#change").setValue(0);d.down("#cashPayment").markInvalid("现金支付金额小于应付金额")}}}else{if(d.type==true){var g=parseFloat(d.down("#accountPayable").getValue());var e=parseFloat(d.down("#memberPayment").getValue());var f=parseFloat(d.currentDeposit);d.down("#memberPayment").suspendEvents();d.down("#change").suspendEvents();if(g>d.numAdd(j,e)){var l=d.numSub(g,j);if(f>=l){}else{d.down("#cashPayment").markInvalid("现金支付金额小于应付金额")}}else{if(g==d.numAdd(j,e)){d.down("#change").setValue(0)}else{if(j==0){d.down("#memberPayment").markInvalid("卡支付金额超出消费金额")}else{d.down("#change").setValue(d.numSub(d.numAdd(j,e),g))}}}d.down("#memberPayment").resumeEvents();d.down("#change").resumeEvents()}}d.down("#cashPayment").setValue(j)},delay:200},specialKey:{fn:function(g,e,f){if(e.keyCode==13){d.down("#notes").focus(true)}},delay:200}}},{xtype:"label",style:a,text:"元"}]},{xtype:"fieldcontainer",fieldLabel:"找余金额",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"textfield",itemId:"change",name:"change",fieldStyle:c+";color:green",width:100,readOnly:true,value:0},{xtype:"label",style:a,text:"元"}]},{xtype:"fieldcontainer",fieldLabel:"获得积分",width:240,layout:{type:"hbox",algin:"center"},items:[{xtype:"textfield",itemId:"point",name:"point",fieldStyle:c+";color:green",width:100,readOnly:true,value:0},{xtype:"label",style:a,text:"分"}]},{xtype:"container",border:false,colspan:2,layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"label",margin:"0",height:20,padding:"0 0 0 250",style:"color:red",colspan:2,itemId:"lengthInfo",text:" "},{xtype:"button",itemId:"save",text:"确定",icon:"images/update.png",scale:"large",width:490,height:50,padding:10,cls:"big-button",handler:function(e){d.onConsume()}}]}]}]},{xtype:"detailmain",title:"会员信息",region:"south",icon:"images/basic_info.png",collapsed:false,collapsible:true,titleCollapse:true,split:true,height:400,userId:this.userId}];return b},onConsume:function(){var a=this.getForm();var i=this;if(a.isValid()){if(i.down("#accountPayable").getValue()>0){var h=i.userId;var b=i.qrString;var k=i.down("#accountPayable").getValue();var d=i.down("#consumeSubject").getValue();var f=i.down("#memberPayment").getValue();var l=i.down("#cashPayment").getValue();var m=i.down("#discount").getValue();var c=i.down("#consumptionAmount").getValue();var g=i.down("#notes").getValue();var e={userId:h,accountPayable:k+"",consumeSubject:d,discount:m+"",cardPayment:f+"",cashPayment:l+"",consumptionAmount:c+"",notes:g};var j=i.down("#change").getValue();if(j>=0){Ext.Msg.confirm("确认","确认 ["+i.userAccountName+"] 消费 ["+k+"] 元 卡支付 ["+f+"] 元 现金支付 ["+l+"]",function(n){if(n=="yes"){if(i.type){ConsumeAction.consumeFromDeposit(b,e,function(o){if(o.success){Ext.Msg.info("消费成功.",function(){i.doPrint(o.data._id);i.close()})}else{Ext.Msg.error(o.message)}})}else{ConsumeAction.consume(h,e,function(o){if(o.success){Ext.Msg.info("消费成功.",function(){i.doPrint(o.data._id);i.close()})}else{Ext.Msg.error(o.message)}})}}})}else{Ext.Msg.error("输入错误")}}else{Ext.Msg.error("消费金额不能为  0",function(){i.down("#consumptionAmount").focus(true,100)},i)}}},load:function(a,c,b){var d=this;if(a){this.userId=a}d.removeAll(true);d.type=c;d.qrString=b;ConsumeAction.canConsume(function(e){if(e.success){MemberAction.getMemberById(d.userId,function(f){var g=f.data;d.discountRate=g.discountRate;d.currentDeposit=g.currentDeposit;d.hasPassword=g.hasPassword;d.userAccountName=g.userAccountName;d.add(d.createView());d.addListeners();d.down("#consumptionAmount").focus(true,100);if(c==true){d.down("#memberPayment").setReadOnly(false)}})}else{Ext.Msg.error(e.message)}})},memberSearch:function(){var a=this;Ext.create("VIP.search.SearchMember",{onRecordSelect:{fn:function(b,d,c){a.load(b,d,c)}}}).show()},initComponent:function(){this.callParent(arguments);this.memberSearch()},specialKeyListener:function(e,c){var a=this.getForm().getFields().items;var b=a.indexOf(e);if(c.keyCode==13){b++;var d=a[b];while(d.readOnly||d.isDisabled()||!d.focus||d.xtype=="textarea"||d.xtype=="displayfield"){b++;d=a[b]}d.focus(true,100)}},addListeners:function(){var a=this.getForm().getFields().items;for(var b=0;b<a.length;b++){var c=a[b];if(c.xtype=="radio"||c.xtype=="textarea"){continue}else{c.on("specialKey","specialKeyListener",this)}}},doPrint:function(b){var a=this;Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/consume.jsp?id="+b}).show()},numAdd:function(d,b){var a,g,f;try{g=d.toString().split(".")[1].length}catch(c){g=0}try{f=b.toString().split(".")[1].length}catch(c){f=0}a=Math.pow(10,Math.max(g,f));return(d*a+b*a)/a},numSub:function(f,c){var b,h,g;var a;try{h=f.toString().split(".")[1].length}catch(d){h=0}try{g=c.toString().split(".")[1].length}catch(d){g=0}b=Math.pow(10,Math.max(h,g));a=(h>=g)?h:g;return((f*b-c*b)/b).toFixed(a)}});Ext.define("VIP.member.IntegralExchange",{extend:Ext.form.Panel,alias:["widget.integralexchange"],icon:"images/Coin256.png",userId:null,moneyBackRate:null,layout:"border",createView:function(){var d=this;var a="font-size:11pt;margin-top:12px";var c="font-size:14pt;background-image:none;border-width:0px 0px 1px 0px";var b=[{xtype:"panel",region:"center",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"tabpanel",width:300,defaults:{bodyPadding:10},items:[{title:"积分兑换金额",xtype:"form",width:300,height:210,bodyPadding:10,layout:{type:"vbox"},fieldDefaults:{height:30,border:false,labelStyle:a,fieldStyle:c,labelAlign:"right",labelWidth:110,width:340,hideTrigger:true,selectOnFocus:true},items:[{xtype:"fieldcontainer",fieldLabel:"消耗积分",layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",name:"realAmount",itemId:"realAmount",width:100,fieldStyle:c+";color:red",allowBlank:false,mouseWheelEnabled:false,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000",listeners:{change:{fn:function(h,f,g){if(h.getValue()==null||h.getValue()==0||h.getValue()=="e"){d.down("#rewardAmount").setValue(0);d.down("#realAmount").setValue(0)}else{var e=parseFloat(h.getValue())*(parseFloat(d.moneyBackRate))/100;d.down("#rewardAmount").setValue(e)}},delay:200},specialKey:{fn:function(g,e,f){if(e.keyCode==13){d.down("#rewardAmount").focus(true)}},delay:200}}},{xtype:"label",style:a,text:"分"}]},{xtype:"fieldcontainer",fieldLabel:"兑换金额",layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",name:"rewardAmount",itemId:"rewardAmount",width:100,fieldStyle:c+";color:#FF9912",readOnly:true,mouseWheelEnabled:false,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000"},{xtype:"label",style:a,text:"元"}]},{xtype:"container",border:false,width:280,margin:"15 0 0 0",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"button",itemId:"save",text:"确定",icon:"images/update.png",scale:"large",width:190,height:60,padding:10,cls:"big-button",handler:function(e){d.exchangeSave()}}]}]},{title:"积分兑换商品",xtype:"form",width:300,height:210,bodyPadding:10,layout:{type:"vbox"},fieldDefaults:{height:30,border:false,labelStyle:a,fieldStyle:c,labelAlign:"right",labelWidth:110,width:340,hideTrigger:true,selectOnFocus:true},items:[{xtype:"fieldcontainer",fieldLabel:"消耗积分",layout:{type:"hbox",algin:"center"},items:[{xtype:"numberfield",name:"realAmount",itemId:"realAmount",width:100,fieldStyle:c+";color:red",allowBlank:false,mouseWheelEnabled:false,value:0,minValue:0,maxValue:100000,negativeText:"最小值为0,最大值为100000",listeners:{change:{fn:function(h,f,g){if(h.getValue()==null||h.getValue()==0||h.getValue()=="e"){d.down("#rewardAmount").setValue(0);d.down("#realAmount").setValue(0)}else{var e=parseFloat(h.getValue())*(parseFloat(d.moneyBackRate))/100;d.down("#rewardAmount").setValue(e)}},delay:200},specialKey:{fn:function(g,e,f){if(e.keyCode==13){d.down("#rewardAmount").focus(true)}},delay:200}}},{xtype:"label",style:a,text:"分"}]},{xtype:"fieldcontainer",fieldLabel:"兑换商品",layout:{type:"hbox",algin:"center"},items:[{xtype:"textfield",name:"rewardAmount",itemId:"rewardAmount",width:100,fieldStyle:c+";color:#FF9912"}]},{xtype:"container",border:false,width:280,margin:"15 0 0 0",layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"button",itemId:"save",text:"确定",icon:"images/update.png",scale:"large",width:190,height:60,padding:10,cls:"big-button",handler:function(e){d.exchangeSave()}}]}]}]}]},{xtype:"detailmain",title:"会员信息",icon:"images/basic_info.png",region:"south",collapsed:false,collapsible:true,titleCollapse:true,split:true,height:400,userId:this.userId}];return b},load:function(a){var b=this;if(a){this.userId=a}this.removeAll(true);b.add(b.createView())},memberSearch:function(){var a=this;Ext.create("VIP.search.SearchMember",{onRecordSelect:{fn:function(b){a.load(b)}}}).show()},initComponent:function(){this.callParent(arguments);this.memberSearch()},});Ext.define("VIP.west.MemberManage",{extend:Ext.panel.Panel,alias:["widget.vipwestmembermanage"],title:"会员管理",iconCls:"west-membermanage",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text,d.itemId)};var a=[{text:"会员档案",icon:"images/member_info-16.png",itemId:"member",handler:b},{text:"充值",icon:"images/deposit-16.png",itemId:"deposit",handler:b},{text:"取款",icon:"images/withdraw.png",itemId:"withdraw",handler:b},{text:"消费",icon:"images/consume-16.png",itemId:"consume",handler:b},{text:"积分兑换",icon:"images/Coin256.png",itemId:"integral",handler:b}];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(b,c){var a=this;vip.viewport.main.removeAll();a.up().changeLink(c);if(b=="会员档案"){MemberAction.canList(function(d){if(d.success){vip.viewport.main.add({xtype:"vipmembermemberinfo",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="充值"){MemberAction.canList(function(d){if(d.success){vip.viewport.main.add({xtype:"memberdeposit",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="取款"){MemberAction.canList(function(d){if(d.success){vip.viewport.main.add({xtype:"memberwithdraw",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="消费"){MemberAction.canList(function(d){if(d.success){vip.viewport.main.add({xtype:"quickconsume",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="积分兑换"){MemberAction.canList(function(d){if(d.success){vip.viewport.main.add({xtype:"integralexchange",title:b})}else{Ext.Msg.error(d.message)}})}}}}}}});Ext.define("VIP.west.ShoppingManage",{extend:Ext.panel.Panel,alias:["widget.vipwestshoppingmanage"],title:"消费管理",iconCls:"west-shoppingmanage",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text)};var a=[{text:"消费",handler:b}];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(a){if(a=="消费"){vip.viewport.main.setContent({xtype:"quickconsume"})}}});Ext.define("VIP.reports.model.DepositHistory",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"userId",type:"string"},{name:"userScreenName",type:"string"},{name:"userName",type:"string"},{name:"operatorName",type:"string"},{name:"shopName",type:"string"},{name:"orderNumber",type:"string"},{name:"realAmount",type:"string"},{name:"rewardAmount",type:"string"},{name:"time",type:"string"},{name:"currentDeposit",type:"string"},{name:"notes",type:"string"},{name:"shopState",type:"string"}]});Ext.define("VIP.reports.DepositGrid",{extend:Ext.grid.Panel,alias:["widget.depositgrid"],icon:"images/deposit_list.png",userId:null,createStore:function(){var a=Ext.create("VIP.reports.store.DepositHistory",{autoLoad:this.autoLoad!=false});var b=a.getProxy().extraParams;if(!b){b={};a.getProxy().extraParams=b}if(this.userId!=null){b.userId=this.userId}return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",hidden:!!this.userId,items:[{xtype:"textfield",fieldLabel:"会员号",emptyText:"请扫描会员身份二维码",labelWidth:40,width:250,margin:"0 5 0 5",inputType:"password",itemId:"qrString",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"会员昵称",emptyText:"会员昵称",labelWidth:60,width:180,margin:"0 5 0 5",itemId:"userScreenName",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}}]},{xtype:"toolbar",dock:"top",items:[{xtype:"datefield",itemId:"start_date",vtype:"daterange",fieldLabel:"充值时间",emptyText:"开始时间",labelWidth:60,maxValue:new Date(),endDateField:"end_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"label",text:"至"},{xtype:"datefield",itemId:"end_date",vtype:"daterange",emptyText:"结束时间",maxValue:new Date(),startDateField:"start_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"单号",labelWidth:30,width:220,emptyText:"请扫描或输入充值单号二维码",itemId:"orderNumber",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"vcombo",fieldLabel:"店铺",labelWidth:30,width:200,margin:"0 5 0 10",emptyText:"选择店铺",itemId:"shopId",value:window.operator.shopId+"",getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}}},{xtype:"button",icon:"images/search-16.png",text:"搜索",handler:function(){b.doSearch()}},"->","-",{xtype:"button",icon:"images/print.png",text:"打印",itemId:"print",disabled:true,handler:function(){var e=b.getSelectionModel().selected.getAt(0).data;b.doPrint(e.id)}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},onSelectChange:function(b,c,a){if(c.length!=0){this.down("#print").enable()}else{this.down("#print").setDisabled(true)}},doPrint:function(a){Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/deposit.jsp?id="+a}).show()},createColumns:function(){var c=this;var a=[{xtype:"rownumberer",text:"序列",align:"center",width:50,sortable:false},{dataIndex:"orderNumber",text:"充值单号",flex:1}];var d=[{dataIndex:"userScreenName",text:"会员昵称",flex:1}];var b=[{dataIndex:"realAmount",text:"充值金额(元)",flex:1},{dataIndex:"rewardAmount",text:"赠送金额(元)",flex:1},{dataIndex:"time",text:"充值时间",flex:1},{dataIndex:"currentDeposit",text:"会员余额(元)",flex:1},{dataIndex:"operatorName",text:"操作人员",flex:1},{dataIndex:"shopName",text:"充值店铺",flex:1,renderer:function(h,f,e){var g=e.raw.shopState;if(g=="1"){return h}else{if(g=="0"){f.style="color:#00F";return h+"　【已冻结】"}else{if(g=="-2"){f.style="color:#F00";return h+"　【已注销】"}else{return h}}}}}];if(c.userId==null){return a.concat(d).concat(b)}else{return a.concat(b)}},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a),columns:this.createColumns()});a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.onSelectChange,this.onSelectChange.scope);this.on("itemdblclick",this.reportInfo,this);this.callParent(arguments)},reportInfo:function(){var c=this;var a=c.getSelectionModel().getSelection()[0].raw;var b=Ext.create("VIP.reports.DepositInfo",{params:{record:a},onSave:{fn:c.refresh,scope:c}});b.show()},doSearch:function(){var h=this;var e=this.down("#orderNumber").getSubmitValue();var d=this.down("#start_date").getSubmitValue();var g=this.down("#end_date").getSubmitValue();var a=this.down("#userScreenName").getSubmitValue();var c=this.down("#qrString").getSubmitValue();var i=this.down("#shopId").getSubmitValue();var f=this.getStore().getProxy().extraParams;var b=this.down("vipform").getForm();if(b.isValid()){if(e){f.orderNumber=e}else{f.orderNumber=undefined}if(d){f.startDate=d}else{f.startDate=undefined}if(g){f.endDate=g}else{f.endDate=undefined}if(a!=""){f.userScreenName=a}else{f.userScreenName=undefined}if(c!=""){f.qrString=c}else{f.qrString=undefined}if(i!=""){f.shopId=i}else{f.shopId=undefined}h.down("#qrString").setValue();h.down("#orderNumber").setValue();this.getStore().loadPage(1)}},refresh:function(){this.getStore().reload()}});Ext.define("VIP.reports.model.ConsumeHistory",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"userId",type:"string"},{name:"userScreenName",type:"string"},{name:"userName",type:"string"},{name:"operatorName",type:"string"},{name:"shopName",type:"string"},{name:"orderNumber",type:"string"},{name:"consumeSubject",type:"string"},{name:"time",type:"string"},{name:"consumptionAmount",type:"string"},{name:"discount",type:"string"},{name:"accountPayable",type:"string"},{name:"cashPayment",type:"string"},{name:"bankCardPaymant",type:"string"},{name:"cardPayment",type:"string"},{name:"changeAmount",type:"string"},{name:"currentDeposit",type:"string"},{name:"type",type:"string"},{name:"notes",type:"string"},{name:"shopState",type:"string"}]});Ext.define("VIP.reports.store.ConsumeHistory",{extend:VIP.store.BaseStore,model:"VIP.reports.model.ConsumeHistory",remoteSort:true,pageSize:50,sorters:[{property:"time",direction:"DESC"}],proxy:{type:"direct",directFn:"ConsumeAction.list",reader:{type:"json",root:"records"}}});Ext.define("VIP.reports.ConsumeGrid",{extend:Ext.grid.Panel,alias:["widget.consumegrid"],icon:"images/consume_list.png",userId:null,createStore:function(){var a=Ext.create("VIP.reports.store.ConsumeHistory",{autoLoad:this.autoLoad!=false});var b=a.getProxy().extraParams;if(!b){b={};a.getProxy().extraParams=b}if(this.userId!=null){b.userId=this.userId}return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",hidden:!!this.userId,items:[{xtype:"textfield",fieldLabel:"会员号",emptyText:"请扫描会员身份二维码",labelWidth:40,width:250,margin:"0 5 0 5",inputType:"password",itemId:"qrString",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"会员昵称",emptyText:"会员昵称",labelWidth:60,width:180,margin:"0 5 0 5",itemId:"userScreenName",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}}]},{xtype:"toolbar",dock:"top",items:[{xtype:"datefield",itemId:"start_date",vtype:"daterange",fieldLabel:"消费时间",emptyText:"开始时间",labelWidth:60,maxValue:new Date(),endDateField:"end_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"label",text:"至"},{xtype:"datefield",itemId:"end_date",vtype:"daterange",emptyText:"结束时间",maxValue:new Date(),startDateField:"start_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"单号",labelWidth:30,emptyText:"请扫描或输入消费单号二维码",itemId:"orderNumber",width:220,listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"vcombo",fieldLabel:"店铺",labelWidth:30,width:200,margin:"0 5 0 10",emptyText:"选择店铺",itemId:"shopId",value:window.operator.shopId+"",getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}}},{xtype:"button",icon:"images/search-16.png",text:"搜索",handler:function(){b.doSearch()}},"->","-",{xtype:"button",icon:"images/print.png",text:"打印",itemId:"print",disabled:true,handler:function(){var e=b.getSelectionModel().selected.getAt(0).data;b.doPrint(e.id)}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},createColumns:function(){var c=this;var a=[{xtype:"rownumberer",width:50,align:"center",text:"序列",sortable:false},{text:"订单号",dataIndex:"orderNumber",flex:1},{text:"内容",dataIndex:"consumeSubject",flex:1,sortable:false}];var d=[{text:"会员昵称",dataIndex:"userScreenName",flex:1}];var b=[{text:"消费金额(元)",dataIndex:"consumptionAmount",flex:1},{text:"应付金额(元)",dataIndex:"accountPayable",flex:1},{text:"折扣金额(元)",dataIndex:"discount",flex:1},{text:"卡支付(元)",dataIndex:"cardPayment",flex:1},{text:"现金支付(元)",dataIndex:"cashPayment",flex:1},{text:"找零(元)",dataIndex:"changeAmount",flex:1},{text:"卡内余额(元)",dataIndex:"currentDeposit",flex:1},{text:"消费时间",dataIndex:"time",flex:2},{text:"消费店铺",dataIndex:"shopName",flex:1,renderer:function(h,f,e){var g=e.raw.shopState;if(g=="1"){return h}else{if(g=="0"){f.style="color:#00F";return h+"　【已冻结】"}else{if(g=="-2"){f.style="color:#F00";return h+"　【已注销】"}else{return h}}}}},{text:"操作员",dataIndex:"operatorName",flex:1}];if(c.userId==null){return a.concat(d).concat(b)}else{return a.concat(b)}},onSelectChange:function(b,c,a){if(c.length!=0){this.down("#print").enable()}else{this.down("#print").setDisabled(true)}},doPrint:function(a){Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/consume.jsp?id="+a}).show()},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a),columns:this.createColumns()});a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.onSelectChange,this.onSelectChange.scope);this.on("itemdblclick",this.reportInfo,this);this.callParent(arguments)},refresh:function(){this.getStore().reload()},reportInfo:function(){var c=this;var a=c.getSelectionModel().getSelection()[0].raw;var b=Ext.create("VIP.reports.ConsumeInfo",{params:{record:a},onSave:{fn:c.refresh,scope:c}});b.show()},doSearch:function(){var h=this;var e=this.down("#orderNumber").getSubmitValue();var d=this.down("#start_date").getSubmitValue();var g=this.down("#end_date").getSubmitValue();var a=this.down("#userScreenName").getSubmitValue();var c=this.down("#qrString").getSubmitValue();var i=this.down("#shopId").getSubmitValue();var b=this.down("vipform").getForm();var f=this.getStore().getProxy().extraParams;if(b.isValid()){if(e){f.orderNumber=e}else{f.orderNumber=undefined}if(d){f.startDate=d}else{f.startDate=undefined}if(g){f.endDate=g}else{f.endDate=undefined}if(a!=""){f.userScreenName=a}else{f.userScreenName=undefined}if(c!=""){f.qrString=c}else{f.qrString=undefined}if(i!=""){f.shopId=i}else{f.shopId=undefined}h.down("#orderNumber").setValue();h.down("#qrString").setValue();this.getStore().loadPage(1)}}});Ext.define("VIP.reports.model.WithdrawHistory",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"userId",type:"string"},{name:"userScreenName",type:"string"},{name:"userName",type:"string"},{name:"operatorName",type:"string"},{name:"shopName",type:"string"},{name:"orderNumber",type:"string"},{name:"amount",type:"string"},{name:"time",type:"string"},{name:"currentDeposit",type:"string"},{name:"notes",type:"string"},{name:"shopState",type:"string"}]});Ext.define("VIP.reports.WithdrawHistoryGrid",{extend:Ext.grid.Panel,alias:["widget.withdrawhistorygrid"],layout:"fit",iconCls:"icon-member-withdraw",icon:"images/withdraw_list.png",userId:null,createStore:function(){var a=Ext.create("VIP.reports.store.WithdrawHistory",{autoLoad:this.autoLoad!=false});var b=a.getProxy().extraParams;if(!b){b={};a.getProxy().extraParams=b}if(this.userId!=null){b.userId=this.userId}return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",hidden:!!this.userId,items:[{xtype:"textfield",fieldLabel:"会员号",emptyText:"请扫描会员身份二维码",labelWidth:40,width:250,margin:"0 5 0 5",inputType:"password",itemId:"qrString",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"会员昵称",emptyText:"会员昵称",labelWidth:60,width:180,margin:"0 5 0 5",itemId:"userScreenName",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}}]},{xtype:"toolbar",dock:"top",items:[{xtype:"datefield",itemId:"start_date",fieldLabel:"取款时间",emptyText:"开始时间",labelWidth:60,vtype:"daterange",endDateField:"end_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"label",text:"至"},{xtype:"datefield",itemId:"end_date",emptyText:"结束时间",vtype:"daterange",startDateField:"start_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"单号",labelWidth:30,width:220,emptyText:"请扫描或输入取款单号二维码",itemId:"orderNumber",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"vcombo",fieldLabel:"店铺",labelWidth:30,width:200,margin:"0 5 0 10",emptyText:"选择店铺",itemId:"shopId",value:window.operator.shopId+"",getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}}},{xtype:"button",icon:"images/search-16.png",text:"搜索",handler:function(){b.doSearch()}},"->","-",{xtype:"button",icon:"images/print.png",text:"打印",itemId:"print",disabled:true,handler:function(){var e=b.getSelectionModel().selected.getAt(0).data;b.doPrint(e.id)}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},createColumns:function(){var c=this;var a=[{xtype:"rownumberer",width:50,align:"center",text:"序列",sortable:false},{dataIndex:"orderNumber",text:"取款单号",flex:1},{dataIndex:"shopName",text:"取款店铺",flex:1,renderer:function(h,f,e){var g=e.raw.shopState;if(g=="1"){return h}else{if(g=="0"){f.style="color:#00F";return h+"　【已冻结】"}else{if(g=="-2"){f.style="color:#F00";return h+"　【已注销】"}else{return h}}}}}];var d=[{dataIndex:"userScreenName",text:"会员昵称",flex:1}];var b=[{dataIndex:"amount",text:"取款金额(元)",flex:1},{dataIndex:"time",text:"取款时间",flex:1},{text:"卡内余额(元)",dataIndex:"currentDeposit",flex:1},{dataIndex:"operatorName",text:"操作员",flex:1}];if(c.userId==null){return a.concat(d).concat(b)}else{return a.concat(b)}},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a),columns:this.createColumns()});a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.onSelectChange,this.onSelectChange.scope);this.on("itemdblclick",this.reportInfo,this);this.callParent(arguments)},reportInfo:function(){var c=this;var a=c.getSelectionModel().getSelection()[0].raw;var b=Ext.create("VIP.reports.WithdrawInfo",{params:{record:a},onSave:{fn:c.refresh,scope:c}});b.show()},onSelectChange:function(b,c,a){if(c.length!=0){this.down("#print").enable()}else{this.down("#print").setDisabled(true)}},doPrint:function(a){Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/withdraw.jsp?id="+a}).show()},doSearch:function(){var h=this;var e=this.down("#orderNumber").getSubmitValue();var d=this.down("#start_date").getSubmitValue();var g=this.down("#end_date").getSubmitValue();var a=this.down("#userScreenName").getSubmitValue();var c=this.down("#qrString").getSubmitValue();var i=this.down("#shopId").getSubmitValue();var f=this.getStore().getProxy().extraParams;var b=this.down("vipform").getForm();if(b.isValid()){if(e){f.orderNumber=e}else{f.orderNumber=undefined}if(d){f.startDate=d}else{f.startDate=undefined}if(g){f.endDate=g}else{f.endDate=undefined}if(a!=""){f.userScreenName=a}else{f.userScreenName=undefined}if(c!=""){f.qrString=c}else{f.qrString=undefined}if(i!=""){f.shopId=i}else{f.shopId=undefined}h.down("#orderNumber").setValue();h.down("#qrString").setValue();this.getStore().loadPage(1)}},refresh:function(){this.getStore().reload()}});Ext.define("VIP.reports.model.OperationLog",{extend:Ext.data.Model,fields:[{name:"time",type:"string"},{name:"operatorName",type:"string"},{name:"shopName",type:"string"},{name:"description",type:"string"}]});Ext.define("VIP.reports.store.OperationLog",{extend:VIP.store.BaseStore,model:"VIP.reports.model.OperationLog",remoteSort:true,pageSize:50,sorters:[{property:"time",direction:"DESC"}],proxy:{type:"direct",directFn:"OperationLogAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.reports.OperationLogGrid",{extend:Ext.grid.Panel,alias:["widget.operationloggrid"],icon:"images/log_list.png",columns:[{xtype:"rownumberer",width:50,text:"序列",align:"center",sortable:false},{text:"时间",dataIndex:"time",flex:2},{text:"操作员",dataIndex:"operatorName",flex:1},{text:"店铺名称",dataIndex:"shopName",flex:1},{text:"操作内容",dataIndex:"description",flex:5}],createStore:function(){var a=Ext.create("VIP.reports.store.OperationLog");return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",items:[{xtype:"datefield",fieldLabel:"操作时间",emptyText:"开始时间",labelWidth:60,itemId:"start_date",vtype:"daterange",maxValue:new Date(),endDateField:"end_date"},{xtype:"label",margin:"0 5 0 5",text:"至"},{xtype:"datefield",itemId:"end_date",emptyText:"结束时间",vtype:"daterange",maxValue:new Date(),startDateField:"start_date"},{xtype:"vcombo",fieldLabel:"店铺",labelWidth:30,emptyText:"选择店铺",margin:"0 5 0 10",itemId:"shopId",getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}},listeners:{change:{fn:function(h,e,f){var g=h.getValue();b.down("#operatorId").clearValue();b.updateCbo(g)},delay:200}}},{xtype:"vcombo",fieldLabel:"操作员",labelWidth:50,emptyText:"选择操作员",margin:"0 5 0 10",itemId:"operatorId",getProxy:function(){return{type:"direct",directFn:"OperatorAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}}},{icon:"images/search-16.png",text:"搜索",handler:function(e){e.up("operationloggrid").doSearch()}}]}]}];var c={xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.callParent(arguments)},updateCbo:function(b){var a=this;var c;if(b!=""&&b!=null){c={shopId:b,page:1,start:0,limit:25}}else{c={allowBlank:true,blankText:"全部",page:1,start:0,limit:25}}OperatorAction.listAsOption(c,function(d){a.down("#operatorId").setOptions(d)})},doSearch:function(){var a=this.down("#start_date").getSubmitValue();var e=this.down("#end_date").getSubmitValue();var d=this.down("#shopId").getSubmitValue();var b=this.down("#operatorId").getSubmitValue();var f=this.getStore().getProxy().extraParams;var c=this.down("vipform").getForm();if(c.isValid()){if(!f){f={};this.getStore().getProxy().extraParams=f}if(a){f.startDate=a}else{f.startDate=undefined}if(e){f.endDate=e}else{f.endDate=undefined}if(d){f.shopId=d}else{f.shopId=undefined}if(b){f.operatorId=b}else{f.operatorId=undefined}this.getStore().loadPage(1)}}});Ext.define("VIP.reports.MemberGrid",{extend:Ext.grid.Panel,alias:["widget.reportmembergrid"],icon:"images/member_list.png",layout:"fit",selType:"checkboxmodel",columns:[{xtype:"rownumberer",text:"序列",align:"center",width:50,sortable:false},{text:"会员昵称",dataIndex:"userScreenName",flex:2},{text:"级别",dataIndex:"vipCardTypeName",flex:1},{text:"消费总额(元)",dataIndex:"totalConsume",flex:1},{text:"当前余额(元)",dataIndex:"currentDeposit",flex:1}],createStore:function(){var a=Ext.create("VIP.member.store.Member");return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",hidden:!!this.userId,defaults:{labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:"会员号",emptyText:"请扫描会员身份二维码",labelWidth:60,labeAlign:"right",width:250,inputType:"password",itemId:"qrString",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doQueryReport()}},delay:200}}},{xtype:"textfield",fieldLabel:"会员昵称",emptyText:"会员昵称",labelWidth:60,width:180,itemId:"userScreenName",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doQueryReport()}},delay:200}}}]},{xtype:"toolbar",dock:"top",defaults:{hideTrigger:true,labelAlign:"right"},items:[{xtype:"label",text:"当前余额 ￥"},{xtype:"numberfield",itemId:"depositStart",vtype:"numberrange",emptyText:"余额最小值",maxNumber:"depositEnd",decimalPrecision:2,width:80,listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doQueryReport()}},delay:200}}},{xtype:"label",text:"至"},{xtype:"numberfield",vtype:"numberrange",itemId:"depositEnd",emptyText:"余额最大值",minNumber:"depositStart",decimalPrecision:2,width:80,listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doQueryReport()}},delay:200}}},{xtype:"label",text:"元"},{xtype:"label",text:"消费总额 ￥"},{xtype:"numberfield",itemId:"totalConsumeStart",minText:"不能小于0",minValue:0,emptyText:"消费最小值",vtype:"numberrange",decimalPrecision:2,maxNumber:"totalConsumeEnd",width:80,listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doQueryReport()}},delay:200}}},{xtype:"label",text:"至"},{xtype:"numberfield",itemId:"totalConsumeEnd",decimalPrecision:2,emptyText:"消费最大值",minText:"不能小于0",minValue:0,vtype:"numberrange",minNumber:"totalConsumeStart",width:80,listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doQueryReport()}},delay:200}}},{xtype:"label",text:"元"},{xtype:"vcombo",fieldLabel:"会员等级",labelWidth:63,width:183,itemId:"membershipTypeId",value:"",emptyText:"选择等级",getProxy:function(){return{type:"direct",directFn:"MembershipTypeAction.listAsOption",reader:{type:"json",root:"records"},extraParams:{allowBlank:true,blankText:"全部"}}}},{xtype:"button",icon:"images/search-16.png",text:"搜索",handler:function(){b.doQueryReport()}},"->",{xtype:"button",text:"修改会员等级",disabled:true,itemId:"change",icon:"images/change_level-16.png",handler:function(){b.changeMemberType()}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.callParent(arguments);this.on("selectionchange",this.resetButtonStatus,this)},changeMemberType:function(){var a=this;MemberAction.canChangeMembershipType(function(b){if(b.success){var d=a.getSelectionModel().getSelection();var j=[];var g=0;var h=null;for(var f=0;f<d.length;f++){var c=d[f];var e=c.raw.userId;j.push(e)}if(j.length==1){g=d[0].raw.membershipTypeId;h=Ext.create("VIP.member.ChangeMemberType",{userIds:j,membershipTypeId:g,onSave:{fn:a.refresh,scope:a}})}else{h=Ext.create("VIP.member.ChangeMemberType",{userIds:j,onSave:{fn:a.refresh,scope:a}})}h.show()}else{Ext.Msg.error(b.message)}})},resetButtonStatus:function(a,b){var c=this;if(b.length>0){c.down("#change").setDisabled(false)}else{c.down("#change").setDisabled(true)}},doQueryReport:function(){var i=this;var e=this.down("#qrString").getSubmitValue();var a=this.down("#userScreenName").getSubmitValue();var b=this.down("#depositStart").getSubmitValue();var f=this.down("#depositEnd").getSubmitValue();var c=this.down("#totalConsumeStart").getSubmitValue();var j=this.down("#totalConsumeEnd").getSubmitValue();var h=this.down("#membershipTypeId").getSubmitValue();var g=this.getStore().getProxy().extraParams;var d=this.down("vipform").getForm();if(d.isValid()){if(!g){g={};this.getStore().getProxy().extraParams=g}if(b<0||f<0||c<0||j<0){return false}if(e!=""){g.qrString=e}else{g.qrString=undefined}if(a!=""){g.accountName=a}else{g.accountName=undefined}if(b!=""){g.depositStart=b}else{g.depositStart=undefined}if(f!=""){g.depositEnd=f}else{g.depositEnd=undefined}if(c!=""){g.totalConsumeStart=c}else{g.totalConsumeStart=undefined}if(j!=""){g.totalConsumeEnd=j}else{g.totalConsumeEnd=undefined}if(h!=""){g.membershipTypeId=h}else{g.membershipTypeId=undefined}i.down("#qrString").setValue();this.getStore().loadPage(1)}},refresh:function(){this.getStore().reload()}});Ext.define("VIP.reports.model.IntegralHistory",{extend:Ext.data.Model,fields:[]});Ext.define("VIP.reports.IntegralGrid",{extend:Ext.grid.Panel,alias:["widget.integralgrid"],requires:[],icon:"images/Coin256.png",userId:null,createStore:function(){var a=Ext.create("VIP.reports.store.IntegralHistory",{autoLoad:this.autoLoad!=false});var b=a.getProxy().extraParams;if(!b){b={};a.getProxy().extraParams=b}if(this.userId!=null){b.userId=this.userId}return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",hidden:!!this.userId,items:[{xtype:"textfield",fieldLabel:"会员号",emptyText:"请扫描会员身份二维码",labelWidth:40,width:250,margin:"0 5 0 5",inputType:"password",itemId:"qrString",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"会员昵称",emptyText:"会员昵称",labelWidth:60,width:180,margin:"0 5 0 5",itemId:"userScreenName",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}}]},{xtype:"toolbar",dock:"top",items:[{xtype:"datefield",itemId:"start_date",vtype:"daterange",fieldLabel:"充值时间",emptyText:"开始时间",labelWidth:60,maxValue:new Date(),endDateField:"end_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"label",text:"至"},{xtype:"datefield",itemId:"end_date",vtype:"daterange",emptyText:"结束时间",maxValue:new Date(),startDateField:"start_date",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"单号",labelWidth:30,width:220,emptyText:"请扫描或输入充值单号二维码",itemId:"orderNumber",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"vcombo",fieldLabel:"店铺",labelWidth:30,width:200,margin:"0 5 0 10",emptyText:"选择店铺",itemId:"shopId",value:window.operator.shopId+"",getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}}},{xtype:"button",icon:"images/search-16.png",text:"搜索",handler:function(){b.doSearch()}},"->","-",{xtype:"button",icon:"images/print.png",text:"打印",itemId:"print",disabled:true,handler:function(){var e=b.getSelectionModel().selected.getAt(0).data;b.doPrint(e.id)}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},onSelectChange:function(b,c,a){if(c.length!=0){this.down("#print").enable()}else{this.down("#print").setDisabled(true)}},doPrint:function(a){Ext.create("VIP.common.PrintWindow",{title:"打印预览",modal:true,frame:true,url:"print/deposit.jsp?id="+a}).show()},createColumns:function(){var c=this;var a=[{xtype:"rownumberer",text:"序列",align:"center",width:50,sortable:false},{dataIndex:"",text:"兑换单号",flex:1}];var d=[{dataIndex:"",text:"会员昵称",flex:1}];var b=[{dataIndex:"",text:"兑换积分(分)",flex:1},{dataIndex:"",text:"获取金额(分)",flex:1},{dataIndex:"",text:"兑换时间",flex:1},{dataIndex:"",text:"剩余积分(分)",flex:1},{dataIndex:"",text:"操作人员",flex:1},{dataIndex:"",text:"兑换店铺",flex:1,renderer:function(g,f,e){}}];if(c.userId==null){return a.concat(d).concat(b)}else{return a.concat(b)}},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a),columns:this.createColumns()});a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.onSelectChange,this.onSelectChange.scope);this.on("itemdblclick",this.reportInfo,this);this.callParent(arguments)},doSearch:function(){var h=this;var e=this.down("#orderNumber").getSubmitValue();var d=this.down("#start_date").getSubmitValue();var g=this.down("#end_date").getSubmitValue();var a=this.down("#userScreenName").getSubmitValue();var c=this.down("#qrString").getSubmitValue();var i=this.down("#shopId").getSubmitValue();var f=this.getStore().getProxy().extraParams;var b=this.down("vipform").getForm();if(b.isValid()){if(e){f.orderNumber=e}else{f.orderNumber=undefined}if(d){f.startDate=d}else{f.startDate=undefined}if(g){f.endDate=g}else{f.endDate=undefined}if(a!=""){f.userScreenName=a}else{f.userScreenName=undefined}if(c!=""){f.qrString=c}else{f.qrString=undefined}if(i!=""){f.shopId=i}else{f.shopId=undefined}h.down("#qrString").setValue();h.down("#orderNumber").setValue();this.getStore().loadPage(1)}},refresh:function(){this.getStore().reload()}});Ext.define("VIP.west.Reports",{extend:Ext.panel.Panel,alias:["widget.vipwestreports"],title:"统计报表",collapsible:false,iconCls:"west-statistics",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text,d.itemId)};var a=[{text:"充值明细报表",icon:"images/deposit_list.png",itemId:"depositReports",handler:b},{text:"消费明细报表",icon:"images/consume_list.png",itemId:"consumeReports",handler:b},{text:"取款明细报表",icon:"images/withdraw_list.png",itemId:"withdrawReports",handler:b},{text:"会员信息报表",icon:"images/member_list.png",itemId:"memberReports",handler:b},{text:"积分兑换报表",icon:"images/Coin256.png",itemId:"integral",handler:b},{text:"操作日志报表",icon:"images/log_list.png",itemId:"logReports",handler:b}];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(b,c){var a=this;vip.viewport.main.removeAll();a.up().changeLink(c);if(b=="充值明细报表"){DepositAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"depositgrid",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="消费明细报表"){ConsumeAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"consumegrid",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="取款明细报表"){WithdrawAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"withdrawhistorygrid",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="操作日志报表"){OperationLogAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"operationloggrid",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="会员信息报表"){MemberAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"reportmembergrid",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="积分兑换报表"){vip.viewport.main.setContent({xtype:"integralgrid",title:b})}}}}}}}});Ext.define("VIP.sms.model.SMSTemplate",{extend:Ext.data.Model,fields:[{name:"content",type:"string"},{name:"type",type:"string"},{name:"name",type:"string"},{name:"id",type:"string"}]});Ext.define("VIP.sms.store.SMSTemplate",{extend:VIP.store.BaseStore,model:"VIP.sms.model.SMSTemplate",remoteSort:true,pageSize:50,sorters:[{property:"type",direction:"DESC"}],proxy:{type:"direct",directFn:"SMSTemplateAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.sms.AddStaticSMSContent",{extend:Ext.window.Window,alias:["widget.addstaticsmscontent"],layout:"fit",width:500,height:200,title:"添加短信模板",modal:true,border:false,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/ok-16.png",width:90,handler:function(c){b.addTemplate()}},{text:"取消",icon:"images/cancel-16.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"textfield",name:"name",fieldLabel:"名称",itemId:"name",anchor:"100% 20%",allowBlank:false},{xtype:"textareafield",grow:true,name:"content",itemId:"content",fieldLabel:"短信内容",allowBlank:false,anchor:"100% 80%"}]}];return a},addTemplate:function(){var d=this;var c=d.down("vipform").getForm();if(c.isValid()){var a=d.down("#name").getValue();var b=d.down("#content").getValue();SMSTemplateAction.add({name:a,content:b,type:"0"},function(e){Ext.Msg.info(e.message,function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.down("vipform").getForm().reset()})})}},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)}});Ext.define("VIP.sms.EditStaticSMSContent",{extend:Ext.window.Window,alias:["widget.editstaticsmscontent"],layout:"fit",width:500,height:200,title:"编辑短信模板",modal:true,id:null,border:false,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/ok-16.png",width:90,handler:function(d){var e=b.down("vipform").getForm();if(e.isValid()){var c=b.down("vipform").getValues();SMSTemplateAction.UpdateTemplate({id:b.id,type:"0",name:c.name,content:c.content},function(f){if(b.onSave){b.onSave.fn.call(b.onSave.scope)}Ext.Msg.info(f.message,function(){b.down("vipform").getForm().reset()})})}}},{text:"取消",icon:"images/cancel-16.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"textfield",name:"name",fieldLabel:"名称",allowBlank:false,anchor:"100% 20%"},{xtype:"textareafield",grow:true,name:"content",fieldLabel:"短信内容",allowBlank:false,anchor:"100% 80%"}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.onLoad.fn.call(this.onLoad.scope)}});Ext.define("VIP.sms.StaticSmsContent",{extend:Ext.grid.Panel,alias:["widget.staticsmscontent"],layout:"fit",isChose:null,columns:[{text:"名称 ",dataIndex:"name",flex:2},{text:"短信模板内容",dataIndex:"content",flex:6}],createStore:function(){var a=Ext.create("VIP.sms.store.SMSTemplate");var b=a.getProxy().extraParams;b.type="0";return a},createDockedItems:function(a){var b=this;var d={xtype:"toolbar",dock:"top",items:["->",{xtype:"button",text:"添加",hidden:b.isChose==true,icon:"images/add-16.png",width:80,handler:function(e){Ext.create("VIP.sms.AddStaticSMSContent",{frame:true,onSave:{fn:function(){b.refresh()},scope:this}}).show()}},"-",{xtype:"button",text:"修改",icon:"images/edit-16.png",width:80,hidden:b.isChose==true,itemId:"edit",disabled:true,handler:function(e){b.editStaticSMSConten()}},{xtype:"button",text:"确定",icon:"images/ok-16.png",width:80,hidden:b.isChose!=true,itemId:"ok",disabled:true,handler:function(e){b.choseContent()}},"-",{xtype:"button",text:"删除",icon:"images/delete-16.png",width:80,hidden:b.isChose==true,itemId:"delete",disabled:true,handler:function(f){var e=b.getSelectionModel().selected;var g=e.get(0).data.id;Ext.Msg.confirm("确认","确认要删除该短信模板（id="+g+"）吗?",function(h){if(h=="yes"){SMSTemplateAction.deleteTemplate({id:g},function(i){Ext.Msg.info(i.message);b.refresh()})}})}}]};var c={xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return[d,c]},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.callParent(arguments);this.on("selectionchange",this.resetButtonStatus,this);this.on("celldblclick",this.dodbClick,this)},resetButtonStatus:function(a,b){if(b.length==0){this.down("#edit").setDisabled(true);this.down("#delete").setDisabled(true);this.down("#ok").setDisabled(true)}else{this.down("#edit").setDisabled(false);this.down("#delete").setDisabled(false);this.down("#ok").setDisabled(false)}},dodbClick:function(d,i,b,a,f,h,g,c){if(this.isChose){this.choseContent()}else{this.editStaticSMSConten()}},choseContent:function(){var c=this;var a=c.getSelectionModel().selected;var b=a.get(0).data.content;if(c.setContent){c.onClose.fn.call(c.onClose.scope);c.setContent.fn.call(c.setContent.scope,b)}},editStaticSMSConten:function(){var b=this;var a=b.getSelectionModel().selected;var d=a.get(0).data.id;var c=Ext.create("VIP.sms.EditStaticSMSContent",{frame:true,id:d,onLoad:{fn:function(){SMSTemplateAction.getTemplate({id:d,type:"0"},function(e){c.down("vipform").getForm().setValues(e.data)})},scope:this},onSave:{fn:function(){b.refresh()},scope:this}}).show()},refresh:function(){this.getStore().reload();this.down("#edit").setDisabled(true);this.down("#delete").setDisabled(true)}});Ext.define("VIP.sms.AutoSendTemplate",{extend:Ext.form.Panel,alias:["widget.autosendtemplate"],title:"自动发送模板",iniConsumeSMS:null,iniDepositSMS:null,consumeId:null,depositId:null,createItems:function(){var b=this;var a=[{xtype:"fieldset",title:"消费短信模板",width:500,defaultType:"textfield",defaults:{anchor:"100%"},layout:"anchor",items:[{xtype:"textareafield",grow:true,name:"consumeContent",itemId:"consumeContent",anchor:"100%",disabled:true},{xtype:"panel",border:false,defaults:{xtype:"button",width:60,height:30,margin:10},layout:{type:"hbox",align:"middle ",pack:"center"},width:500,items:[{xtype:"button",text:"编辑",icon:"images/ok-24.png",width:100,scale:"medium",handler:function(c){var d=b.consumeId;var e=Ext.create("VIP.sms.EditConsumeSMS",{frame:true,onLoad:{fn:function(){SMSTemplateAction.getTemplate({id:d,type:"1"},function(f){e.down("vipform").getForm().setValues(f.data)})},scope:b},onSave:{fn:function(){var f=e.down("vipform").getValues();SMSTemplateAction.UpdateTemplate({id:d,type:"1",name:"消费提醒",content:f.content},function(g){Ext.Msg.info(g.message,function(){b.updateConsumeSMS()})})},scope:b}}).show()}},{xtype:"button",text:"重置",icon:"images/undo-24.png",width:100,scale:"medium",handler:function(c){b.down("#consumeContent").setValue(b.iniConsumeSMS)}}]}]},{xtype:"fieldset",title:"充值短信模板",layout:"anchor",width:500,items:[{xtype:"textareafield",grow:true,name:"depositContent",itemId:"depositContent",anchor:"100%",disabled:true},{xtype:"panel",border:false,defaults:{xtype:"button",width:60,height:30,margin:10},layout:{type:"hbox",align:"middle ",pack:"center"},width:500,items:[{xtype:"button",text:"编辑",icon:"images/ok-24.png",width:100,scale:"medium",handler:function(d){var c=b.depositId;var e=Ext.create("VIP.sms.EditDepositSMS",{frame:true,onLoad:{fn:function(){SMSTemplateAction.getTemplate({id:c,type:"2"},function(f){e.down("vipform").getForm().setValues(f.data)})},scope:this},onSave:{fn:function(){var f=e.down("vipform").getValues();SMSTemplateAction.UpdateTemplate({id:c,type:"2",name:"充值提醒",content:f.content},function(g){Ext.Msg.info(g.message,function(){b.updateDepositSMS()})})},scope:this}}).show()}},{xtype:"button",text:"重置",icon:"images/undo-24.png",width:100,scale:"medium",handler:function(c){b.down("#depositContent").setValue(b.iniDepositSMS)}}]}]}];return a},initComponent:function(){var a=this;this.iniConsumeSMS();this.iniDepositSMS();Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},iniConsumeSMS:function(){var a=this;SMSTemplateAction.getTemplate({type:"1"},function(b){a.down("#consumeContent").setValue(b.data.content);a.iniConsumeSMS=b.data.content;a.consumeId=b.data.id})},updateConsumeSMS:function(){var a=this;SMSTemplateAction.getTemplate({type:"1"},function(b){a.down("#consumeContent").setValue(b.data.content)})},iniDepositSMS:function(){var a=this;SMSTemplateAction.getTemplate({type:"2"},function(b){a.down("#depositContent").setValue(b.data.content);a.iniDepositSMS=b.data.content;a.depositId=b.data.id})},updateDepositSMS:function(){var a=this;SMSTemplateAction.getTemplate({type:"2"},function(b){a.down("#depositContent").setValue(b.data.content)})}});Ext.define("VIP.west.SMSManage",{extend:Ext.panel.Panel,alias:["widget.vipwestsmsmanage"],title:"短信管理",iconCls:"west-smsmanage",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text)};var a=[];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(a){}});Ext.define("VIP.message.AddCouponWindow",{extend:Ext.window.Window,alias:["widget.addcouponwindow"],requires:[],layout:"fit",padding:5,icon:"images/promotion.png",title:"添加活动信息",modal:true,resizable:false,border:false,width:462,height:590,num:1,createButtons:function(){var b=this;var a=[{text:"添加描述",handler:function(){b.addDescription()}},{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.save()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,autoScroll:true,layout:{type:"table",columns:2},defaults:{labelWidth:60,labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:"标题",name:"title",itemId:"title",colspan:2,width:400,maxLength:10,maxLengthText:"不可超过10字符",allowBlank:false,vtype:"stringblank",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#initDate").focus(true)}},delay:200}}},{xtype:"datefield",fieldLabel:"开始日期",name:"initDate",itemId:"initDate",minValue:new Date(),allowBlank:false,value:new Date(),vtype:"daterange",endDateField:"expireDate",width:200,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#expireDate").focus(true)}},delay:200}}},{xtype:"datefield",itemId:"expireDate",fieldLabel:"结束日期",name:"expireDate",minValue:new Date(),vtype:"daterange",startDateField:"initDate",width:195,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#content").focus(true)}},delay:200}}},{xtype:"panel",itemId:"description",border:false,colspan:2,items:[]}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);setTimeout(function(){a.down("#title").focus(true);a.addDescription()},200)},choosePicture:function(){var a=this;var b=new CKFinder();b.selectActionFunction=function(c,d){a.setSrc(c)};b.popup(720,540)},addDescription:function(){var b=this;var a=Ext.create("Ext.form.Panel",{border:false,items:[{xtype:"fieldset",margin:"5 10",padding:"5 40",width:390,title:"描述"+b.num,items:[{xtype:"image",name:"picture",style:"border:1px dashed #AAA;cursor:pointer",src:"images/default_image.png",width:300,height:225,colspan:2,listeners:{afterrender:function(c){c.getEl().on("click",b.choosePicture,c)}}},{xtype:"textareafield",name:"content",itemId:"content",emptyText:"活动详情",width:300,height:100,maxLength:500,maxLengthText:"不可超过500字符",margin:"3 0 0 0",colspan:2,listeners:{change:function(f,d){var e=f.getValue().length;var c=500-e;if(c>0&&c!=500){f.nextSibling().setText("还可输入"+c+"个字符")}else{if(c==0||c==500){f.nextSibling().setText("")}else{f.nextSibling().setText("已经超出"+(-c)+"个字符")}}}}},{xtype:"label",margin:"0 100",colspan:2,style:"color:red",text:""},{xtype:"button",width:300,margin:"0 0 20 0",text:"删除本描述",handler:function(d){var c=b.down("#description");if(c.items.length>1){c.remove(d.up().up())}else{Ext.Msg.error("至少添加一条描述")}}}]}]});b.num++;this.down("#description").add(a)},save:function(e){var g=this;var f=this.down("vipform").getForm();var d=new Array();var a=this.query("[name=picture]");for(var c=0;c<a.length;c++){if(a[c].src.indexOf("default_image.png")>=0){Ext.Msg.alert("提示","请添加"+a[c].up().title+"的图片");return}if(a[c].src){d[c]=window.location.protocol+"//"+window.location.host+a[c].src}}if(f.isValid()){var b=f.getValues();Ext.apply(b,{pictureUrl:d});MemberAction.publisCoupons(b,function(h){if(h.success){Ext.Msg.info("添加成功.",function(){if(g.onSave){g.onSave.fn.call(g.onSave.scope)}g.destroy()})}else{Ext.Msg.error(h.message)}})}}});Ext.define("VIP.message.CouponGrid",{extend:Ext.grid.Panel,alias:["widget.coupongrid"],layout:"fit",icon:"images/promotion.png",columns:[{xtype:"rownumberer",width:50,text:"序列",align:"center",sortable:false},{text:"标题",dataIndex:"title",flex:2},{text:"优惠开始时间",dataIndex:"startDate",flex:1},{text:"优惠结束时间",dataIndex:"endDate",flex:1},{text:"创建时间",dataIndex:"createTime",flex:1}],createStore:function(){var a=Ext.create("VIP.message.store.Coupon");return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",defaults:{xtype:"textfield",labelAlign:"right",labelWidth:80},items:[{xtype:"datefield",fieldLabel:"开始时间",itemId:"initDateFrom",vtype:"daterange",endDateField:"initDateTo"},{xtype:"label",text:"至"},{xtype:"datefield",itemId:"initDateTo",vtype:"daterange",startDateField:"initDateFrom"},{xtype:"datefield",fieldLabel:"结束时间",itemId:"expireDateFrom",vtype:"daterange",endDateField:"expireDateTo"},{xtype:"label",text:"至"},{xtype:"datefield",itemId:"expireDateTo",vtype:"daterange",startDateField:"expireDateFrom"},{xtype:"button",icon:"images/search-16.png",text:"搜索",handler:function(){b.doSearch()}},"->",{xtype:"button",text:"添加",icon:"images/add.png",width:80,handler:function(e){e.up("coupongrid").addCoupon()}},"-",{xtype:"button",text:"修改",icon:"images/edit.png",width:80,itemId:"edit",disabled:true,handler:function(e){e.up("coupongrid").editCoupon()}},{xtype:"button",text:"删除",icon:"images/delete.png",width:80,itemId:"delete",disabled:true,handler:function(e){e.up("coupongrid").deleteCoupon()}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.on("selectionchange",this.onSelectChange,this.onSelectChange.scope);this.on("itemdblclick",this.editCoupon,this);this.callParent(arguments)},onSelectChange:function(b,c,a){if(c.length!=0){this.down("#edit").enable();this.down("#delete").enable()}else{this.down("#edit").disable();this.down("#delete").disable()}},doSearch:function(){var b=this.down("#initDateFrom").getSubmitValue();var e=this.down("#initDateTo").getSubmitValue();var d=this.down("#expireDateFrom").getSubmitValue();var a=this.down("#expireDateTo").getSubmitValue();var f=this.getStore().getProxy().extraParams;var c=this.down("vipform").getForm();if(c.isValid()){if(!f){f={};this.getStore().getProxy().extraParams=f}if(b!=""){f.startDateFrom=b}else{f.startDateFrom=undefined}if(e!=""){f.startDateTo=e}else{f.startDateTo=undefined}if(d!=""){f.endDateFrom=d}else{f.endDateFrom=undefined}if(a!=""){f.endDateTo=a}else{f.endDateTo=undefined}this.getStore().loadPage(1)}},refresh:function(){this.getStore().reload()},addCoupon:function(){var a=this;MemberAction.canPublicVIPMessage(function(b){if(b.success){var c=Ext.create("VIP.message.AddCouponWindow",{onSave:{fn:a.refresh,scope:a}});c.show()}else{Ext.Msg.error(b.message)}})},editCoupon:function(){var a=this;MemberAction.canEditVIPMessage(function(b){if(b.success){var c=a.getSelectionModel().getSelection()[0];var d=c.raw.id;var e=Ext.create("VIP.message.EditCouponWindow",{messageId:d,onSave:{fn:a.refresh,scope:a}});e.show()}else{Ext.Msg.error(b.message)}})},deleteCoupon:function(){var b=this;var a=this.getSelectionModel().getSelection()[0];var c=a.raw.title;MemberAction.canEditVIPMessage(function(d){if(d.success){Ext.Msg.confirm("确认","确认要删除信息 ["+c+"] 吗？",function(f){if(f=="yes"){var e=a.raw.id;MemberAction.deleteOffer(e,function(g){if(g.success){b.refresh()}else{Ext.Msg.error(g.message)}})}},this)}else{Ext.Msg.error(d.message)}})}});Ext.define("VIP.message.AddNewsWindow",{extend:Ext.window.Window,alias:["widget.addnewswindow"],requires:[],layout:"fit",padding:5,icon:"images/promotion.png",title:"添加新闻动态",modal:true,resizable:false,border:false,width:432,height:560,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.save()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,layout:{type:"table",columns:2},defaults:{labelWidth:60,labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:"标题",name:"title",itemId:"title",colspan:2,width:400,maxLength:10,maxLengthText:"不可超过10字符",allowBlank:false,vtype:"stringblank",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#initDate").focus(true)}},delay:200}}},{xtype:"image",name:"picture",itemId:"picture",style:"border:1px dashed #AAA;cursor:pointer",width:400,height:300,colspan:2,listeners:{afterrender:function(c){c.getEl().on("click",b.choosePicture,b)}}},{xtype:"textareafield",name:"content",itemId:"content",emptyText:"活动详情",width:400,height:135,maxLength:500,maxLengthText:"不可超过500字符",margin:"3 0 0 0",colspan:2,listeners:{change:function(f,d){var e=f.getValue().length;var c=500-e;if(c>0&&c!=500){b.down("#lengthInfo").setText("还可输入"+c+"个字符")}else{if(c==0||c==500){b.down("#lengthInfo").setText("")}else{b.down("#lengthInfo").setText("已经超出"+(-c)+"个字符")}}}}},{xtype:"label",margin:"0 140",colspan:2,style:"color:red",itemId:"lengthInfo",text:""}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);setTimeout(function(){a.down("#title").focus(true)},500)},choosePicture:function(){var a=this.down("image[name=picture]");var b=new CKFinder();b.selectActionFunction=function(c,d){a.setSrc(c)};b.popup(720,540)},save:function(c){var e=this;var d=this.down("vipform").getForm();var b="";if(this.down("[name=picture]").src){b=window.location.protocol+"//"+window.location.host+this.down("[name=picture]").src}if(d.isValid()){var a=d.getValues();Ext.apply(a,{pictureUrl:b});MemberAction.publisVIPMessage(a,function(f){if(f.success){Ext.Msg.info("添加成功.",function(){if(e.onSave){e.onSave.fn.call(e.onSave.scope)}e.destroy()})}else{Ext.Msg.error(f.message)}})}}});Ext.define("VIP.message.NewsGrid",{extend:Ext.grid.Panel,alias:["widget.newsgrid"],layout:"fit",icon:"images/promotion.png",columns:[{xtype:"rownumberer",width:50,text:"序列",align:"center",sortable:false},{text:"标题",dataIndex:"title",flex:2},{text:"创建时间",dataIndex:"createTime",flex:1}],createStore:function(){var a=Ext.create("VIP.message.store.News");return a},createDockedItems:function(a){var b=this;var d=[{xtype:"vipform",defaults:{border:false},items:[{xtype:"toolbar",dock:"top",defaults:{xtype:"textfield",labelAlign:"right",labelWidth:80},items:["->",{xtype:"button",text:"添加",icon:"images/add.png",width:80,handler:function(e){e.up("newsgrid").addNews()}},"-",{xtype:"button",text:"修改",icon:"images/edit.png",width:80,itemId:"edit",disabled:true,handler:function(e){e.up("newsgrid").editNews()}},{xtype:"button",text:"删除",icon:"images/delete.png",width:80,itemId:"delete",disabled:true,handler:function(e){e.up("newsgrid").deleteNews()}}]}]}];var c={dock:"bottom",xtype:"pagingtoolbar",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return d.concat(c)},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.on("selectionchange",this.onSelectChange,this.onSelectChange.scope);this.on("itemdblclick",this.editNews,this);this.callParent(arguments)},onSelectChange:function(b,c,a){if(c.length!=0){this.down("#edit").enable();this.down("#delete").enable()}else{this.down("#edit").disable();this.down("#delete").disable()}},refresh:function(){this.getStore().reload()},addNews:function(){var a=this;MemberAction.canPublicVIPMessage(function(b){if(b.success){var c=Ext.create("VIP.message.AddNewsWindow",{onSave:{fn:a.refresh,scope:a}});c.show()}else{Ext.Msg.error(b.message)}})},editNews:function(){var a=this;MemberAction.canEditVIPMessage(function(b){if(b.success){var c=a.getSelectionModel().getSelection()[0];var d=c.raw.id;var e=Ext.create("VIP.message.EditNewsWindow",{messageId:d,onSave:{fn:a.refresh,scope:a}});e.show()}else{Ext.Msg.error(b.message)}})},deleteNews:function(){var b=this;var a=this.getSelectionModel().getSelection()[0];var c=a.raw.title;MemberAction.canEditVIPMessage(function(d){if(d.success){Ext.Msg.confirm("确认","确认要删除信息 ["+c+"] 吗？",function(f){if(f=="yes"){var e=a.raw.id;MemberAction.deleteVIPMessage(e,function(g){if(g.success){b.refresh()}else{Ext.Msg.error(g.message)}})}},this)}else{Ext.Msg.error(d.message)}})}});Ext.define("VIP.west.Message",{extend:Ext.panel.Panel,alias:["widget.vipwestmessage"],title:"信息提醒",iconCls:"west-message",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text,d.itemId)};var a=[{text:"促销信息",icon:"images/promotion.png",itemId:"message",hidden:window.localStorage.getItem("allowPublishCoupons")=="false",handler:b},{text:"新闻动态",icon:"images/promotion.png",itemId:"news",hidden:window.localStorage.getItem("allowPublishMessages")=="false",handler:b}];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(b,c){var a=this;vip.viewport.main.removeAll();a.up().changeLink(c);if(b=="促销信息"){MemberAction.canVIPMessageList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"coupongrid",title:b})}else{Ext.Msg.error(d.message)}})}else{if(b=="新闻动态"){MemberAction.canVIPMessageList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"newsgrid",title:b})}else{Ext.Msg.error(d.message)}})}}}});Ext.define("VIP.operator.model.Operator",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"operatorNumber",type:"string"},{name:"accountName",type:"string"},{name:"password",type:"string"},{name:"idCardNumber",type:"string"},{name:"sex",type:"string"},{name:"birthday",type:"string"},{name:"education",type:"string"},{name:"address",type:"string"},{name:"mobile",type:"string"},{name:"shopId",type:"string"},{name:"shopName",type:"string"},{name:"lastSigninTime",type:"string"},{name:"operatorRuleId",type:"string"},{name:"operatorRuleName",type:"string"},{name:"state",type:"string"},{name:"notes",type:"string"}]});Ext.define("VIP.operator.store.Operator",{extend:VIP.store.BaseStore,model:"VIP.operator.model.Operator",sorters:[],remoteSort:true,pageSize:50,proxy:{type:"direct",directFn:"OperatorAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.operator.AddOperatorWindow",{extend:Ext.window.Window,alias:["widget.addoperatorwindow"],layout:"fit",width:640,icon:"images/operator_management.png",height:480,title:"添加操作员",modal:true,border:false,resizable:false,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",itemId:"saveBtn",width:90,disabled:true,handler:function(c){b.saveOperator()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 80%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{fieldLabel:"店铺",xtype:"vcombo",name:"shopId",allowBlank:false,colspan:2,getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption"}},listeners:{change:{fn:function(e,c,d){b.down("#name").focus(true)},delay:200}}},{xtype:"textfield",fieldLabel:"姓名",name:"name",itemId:"name",allowBlank:false,maxLength:"15",maxLengthText:"不可超过15位",vtype:"stringblank",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#accountName").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"用户名",name:"accountName",itemId:"accountName",maxLength:"15",maxLengthText:"不可超过15位",vtype:"stringblank",allowBlank:false,validFlag:true,validator:function(){return this.validFlag},listeners:{blur:function(d){var c=this;OperatorAction.getOperatorByAccountName(d.getValue(),function(e){c.validFlag=e.success?"此用户名已被占用！":true;c.validate()})},specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#password").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"密码",name:"password",itemId:"password",inputType:"password",allowBlank:false,vtype:"password",initialPassField:"passwordAg",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#passwordAg").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"确认密码",name:"passwordAg",itemId:"passwordAg",inputType:"password",allowBlank:false,vtype:"password",initialPassField:"password",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#idCardNumber").focus(true)}},delay:200}}},{xtype:"radiogroup",fieldLabel:"会员性别",columns:3,items:[{boxLabel:"男",name:"sex",checked:true,inputValue:"M"},{boxLabel:"女",name:"sex",inputValue:"F"},{boxLabel:"未知",name:"sex",inputValue:"U"}]},{xtype:"textfield",fieldLabel:"身份证号",name:"idCardNumber",itemId:"idCardNumber",allowBlank:false,regex:/^[1-9][0-9]{5}(19[0-9]{2}|200[0-9]|2013)(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])[0-9]{3}[0-9xX]$/,regexText:"无效的身份证",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#mobile").focus(true)}},delay:200}}},{xtype:"datefield",fieldLabel:"生日",name:"birthday",maxValue:new Date()},{xtype:"vcombo",fieldLabel:"教育程度",name:"education",options:[{text:"小学",value:"小学"},{text:"初中",value:"初中"},{text:"高中",value:"高中"},{text:"大专",value:"大专"},{text:"本科",value:"本科"},{text:"硕士",value:"硕士"},{text:"博士",value:"博士"},{text:"其他",value:"其他"}]},{xtype:"textfield",fieldLabel:"手机号",name:"mobile",itemId:"mobile",colspan:2,allowBlank:false,regex:/^1[3|4|5|8][0-9]{9}$/,regexText:"无效的手机号码",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#address").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"地址",name:"address",itemId:"address",colspan:2,maxLength:"30",maxLengthText:"不可超过30位",width:550,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#notes").focus(true)}},delay:200}}},{xtype:"textareafield",fieldLabel:"备注",name:"notes",itemId:"notes",maxLength:"140",maxLengthText:"不可超过140位",colspan:2,width:550}]},{xtype:"fieldset",title:"操作权限",anchor:"100% 20%",items:{xtype:"vcombo",name:"operatorRuleId",fieldLabel:"角色",labelAlign:"right",width:275,allowBlank:false,getProxy:function(){return{type:"direct",directFn:"OperatorRuleAction.listAsOption"}},listeners:{change:function(e,d,c){b.down("#saveBtn").setDisabled(d==1)}}}}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);setTimeout(function(){a.down("#name").focus(true)},500)},addListeners:function(){},saveOperator:function(b){var d=this;var c=this.down("vipform").getForm();if(c.isValid()){var a=c.getValues();OperatorAction.addOperator(a,function(e){if(e.success){Ext.Msg.info("添加成功.",function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.destroy()})}else{Ext.Msg.error(e.message)}})}}});Ext.define("VIP.operator.EditOperatorWindow",{extend:Ext.window.Window,alias:["widget.editoperatorwindow"],layout:"fit",width:640,height:480,icon:"images/operator_management.png",title:"修改操作员",modal:true,border:false,resizable:false,accountName:null,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",itemId:"saveBtn",width:90,handler:function(c){b.saveOperator()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 80%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{fieldLabel:"店铺",xtype:"vcombo",colspan:2,itemId:"shopId",name:"shopId",allowBlank:false,value:this.params.actionResult.shopId,getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption"}},listeners:{change:{fn:function(e,c,d){b.down("#name").focus(true)},delay:200}}},{xtype:"textfield",fieldLabel:"姓名",name:"name",itemId:"name",maxLength:"15",value:this.params.actionResult.name,maxLengthText:"不可超过15位",vtype:"stringblank",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#accountName").focus(true)}},delay:200}}},,{xtype:"textfield",fieldLabel:"用户名",name:"accountName",itemId:"accountName",vtype:"stringblank",value:this.params.actionResult.accountName,maxLength:"15",maxLengthText:"不可超过15位",allowBlank:false,validFlag:true,validator:function(){return this.validFlag},listeners:{blur:function(d){var c=this;if(d.isDirty()){if(b.accountName!=d.getValue()){OperatorAction.getOperatorByAccountName(d.getValue(),function(e){c.validFlag=e.success?"此用户名已被占用！":true;c.validate()})}else{c.validFlag=true;c.validate()}}},specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#idCardNumber").focus(true)}},delay:200}}},{xtype:"radiogroup",fieldLabel:"会员性别",columns:3,items:[{boxLabel:"男",name:"sex",checked:this.params.actionResult.sex=="M",inputValue:"M"},{boxLabel:"女",name:"sex",checked:this.params.actionResult.sex=="F",inputValue:"F"},{boxLabel:"未知",name:"sex",checked:this.params.actionResult.sex=="U",inputValue:"U"}]},{xtype:"textfield",fieldLabel:"身份证号",name:"idCardNumber",itemId:"idCardNumber",allowBlank:false,value:this.params.actionResult.idCardNumber,regex:/^[1-9][0-9]{5}(19[0-9]{2}|200[0-9]|2013)(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])[0-9]{3}[0-9xX]$/,regexText:"无效的身份证",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#mobile").focus(true)}},delay:200}}},{xtype:"datefield",fieldLabel:"生日",name:"birthday",value:this.params.actionResult.birthday,maxValue:new Date()},{xtype:"vcombo",fieldLabel:"教育程度",name:"education",value:this.params.actionResult.education,options:[{text:"小学",value:"小学"},{text:"初中",value:"初中"},{text:"高中",value:"高中"},{text:"大专",value:"大专"},{text:"本科",value:"本科"},{text:"硕士",value:"硕士"},{text:"博士",value:"博士"},{text:"其他",value:"其他"}]},{xtype:"textfield",fieldLabel:"手机号",name:"mobile",itemId:"mobile",colspan:2,allowBlank:false,value:this.params.actionResult.mobile,regex:/^1[3|4|5|8][0-9]{9}$/,regexText:"无效的手机号码",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#address").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"地址",name:"address",itemId:"address",maxLength:"30",maxLengthText:"不可超过30位",value:this.params.actionResult.address,colspan:2,width:550,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#notes").focus(true)}},delay:200}}},{xtype:"textareafield",fieldLabel:"备注",maxLength:"140",maxLengthText:"不可超过140位",name:"notes",itemId:"notes",value:this.params.actionResult.notes,colspan:2,width:550}]},{xtype:"fieldset",title:"操作权限",anchor:"100% 20%",layout:{type:"table",columns:2},items:[{xtype:"vcombo",name:"operatorRuleId",fieldLabel:"角色",labelAlign:"right",width:275,allowBlank:false,value:this.params.actionResult.operatorRuleId,getProxy:function(){return{type:"direct",directFn:"OperatorRuleAction.listAsOption"}},listeners:{change:function(e,d,c){b.down("#saveBtn").setDisabled(d==1)}}},{fieldLabel:"状态",xtype:"vcombo",name:"state",labelAlign:"right",itemId:"state",value:this.params.actionResult.state,options:[{text:"正常",value:1},{text:"冻结",value:0},{text:"注销",value:-2}],allowBlank:false,listeners:{change:{fn:function(f,c,d){var e=f.getValue();if(e=="-2"){Ext.Msg.info("注销无可逆性,请慎重操作！")}},delay:200}}}]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)},load:function(){var a=this;this.setLoading("读取中...")},saveOperator:function(b){var d=this;var c=this.down("vipform").getForm();if(c.isValid()){var a=c.getValues();OperatorAction.editOperator(Ext.apply({operatorId:this.params.operatorId},a),function(e){if(e.success){Ext.Msg.info("修改成功",function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.destroy()})}else{Ext.Msg.error(e.message)}})}}});Ext.define("VIP.operator.OperatorGrid",{extend:Ext.grid.Panel,alias:["widget.operatorgrid"],title:"",layout:"fit",title:"操作员管理",icon:"images/operator_management.png",columns:[{xtype:"rownumberer",width:50,align:"center",text:"序列",sortable:false},{text:"姓名",dataIndex:"name",flex:1},{text:"用户名",dataIndex:"accountName",flex:1},{text:"所属店铺",dataIndex:"shopName",flex:2,renderer:function(d,b,a){var c=a.raw.shopState;if(c=="1"){return d}else{if(c=="0"){b.style="color:#00F";return d+"　【已冻结】"}else{b.style="color:#F00";return d+"　【已注销】"}}}},{text:"性别",dataIndex:"sex",renderer:function(a){if(a=="M"){return"男"}else{if(a=="F"){return"女"}else{if(a=="U"){return"未知"}else{return a}}}}},{text:"角色",dataIndex:"operatorRuleName"},{text:"最后登录时间",dataIndex:"lastSigninTime",flex:2},{text:"状态",dataIndex:"state",renderer:function(b,a){if(b=="1"){a.style="color:#0f0";return"正常"}else{if(b==0){a.style="color:#00f";return"冻结"}else{if(b=="-1"){a.style="color:#C9C9C9";return"已过期"}else{if(b=="-2"){a.style="color:#C9C9C9";return"已注销"}else{return b}}}}}}],createStore:function(){var a=Ext.create("VIP.operator.store.Operator");return a},createDockedItems:function(a){var b=this;var d={xtype:"toolbar",dock:"top",items:[{xtype:"textfield",fieldLabel:"姓名",labelWidth:30,margin:"0 5 0 10",emptyText:"姓名",width:100,itemId:"name",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"textfield",fieldLabel:"用户名",labelWidth:50,margin:"0 5 0 10",emptyText:"用户名",width:150,itemId:"accountName",listeners:{specialKey:{fn:function(g,e,f){if(e.keyCode==13){b.doSearch()}},delay:200}}},{xtype:"vcombo",fieldLabel:"店铺",labelWidth:30,width:200,margin:"0 5 0 10",emptyText:"选择店铺",itemId:"shopId",getProxy:function(){return{type:"direct",directFn:"ShopAction.listAsOption",extraParams:{allowBlank:true,blankText:"全部"}}}},{xtype:"vcombo",fieldLabel:"状态",labelWidth:30,emptyText:"选择状态",width:125,margin:"0 5 0 10",itemId:"state",options:[{text:"全部",value:""},{text:"正常",value:"1"},{text:"冻结",value:"0"}]},{xtype:"button",icon:"images/search-16.png",text:"搜索",width:70,handler:function(e){e.up("operatorgrid").doSearch()}},"->","-",{xtype:"button",text:"添加",icon:"images/add.png",width:80,handler:function(e){e.up("operatorgrid").addOperator()}},"-",{xtype:"button",text:"修改",icon:"images/edit.png",width:80,itemId:"edit",disabled:true,handler:function(e){e.up("operatorgrid").editOperator()}},"-",{xtype:"button",text:"注销",icon:"images/delete.png",width:80,itemId:"delete",disabled:true,handler:function(e){e.up("operatorgrid").deleteOperator()}},"-",{xtype:"button",text:"重置密码",icon:"images/reset_password.png",width:100,itemId:"restore",disabled:true,handler:function(e){e.up("operatorgrid").restorePassword()}}]};var c={xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return[d,c]},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.callParent(arguments);this.on("selectionchange",this.resetButtonStatus,this);this.on("itemdblclick",this.editOperator,this)},doSearch:function(){var b=this.down("#name").getValue();var c=this.down("#shopId").getValue();var a=this.down("#accountName").getValue();var d=this.down("#state").getValue();var e=this.getStore().getProxy().extraParams;if(!e){e={};this.getStore().getProxy().extraParams=e}e.start=0;if(b!=""){e.name=b}else{delete e.name}if(a!=""){e.accountName=a}else{delete e.accountName}if(c!=""){e.shopId=c}else{delete e.shopId}if(d!=""){e.state=d}else{delete e.state}this.getStore().loadPage(1)},refresh:function(){this.getStore().reload()},resetButtonStatus:function(c,d){if(d.length==1){var a=this.getSelectionModel().getSelection()[0];var b=a.raw.id;this.down("#restore").setDisabled(b==1);this.down("#edit").setDisabled(b==1);this.down("#delete").setDisabled(b==1)}else{this.down("#restore").setDisabled(true);this.down("#edit").setDisabled(true);this.down("#delete").setDisabled(true)}},addOperator:function(){var a=this;OperatorAction.canAddOperator(function(b){if(b.success){var c=Ext.create("VIP.operator.AddOperatorWindow",{onSave:{fn:a.refresh,scope:a}});c.show()}else{Ext.Msg.error(b.message)}})},editOperator:function(){var a=this;OperatorAction.canEditOperator(function(b){if(b.success){var c=a.getSelectionModel().getSelection()[0];var d=c.raw.id;if(d!=1){OperatorAction.getOperatorById(d,function(e){var f=Ext.create("VIP.operator.EditOperatorWindow",{params:{operatorId:d,actionResult:e.data},onSave:{fn:a.refresh,scope:a}});f.show()})}}else{Ext.Msg.error(b.message)}})},restorePassword:function(){var c=this;var a=this.getSelectionModel().getSelection()[0];var b=a.raw.name;OperatorAction.canRestorePassword(function(d){if(d.success){Ext.Msg.confirm("确认","确认要重置操作员 ["+b+"]的密码吗？",function(f){if(f=="yes"){var e=a.raw.id;OperatorAction.restorePassword(e,function(g){if(g.success){Ext.Msg.info("重置成功");c.refresh()}else{Ext.Msg.error(g.message)}})}},this)}else{Ext.Msg.error(d.message)}})},deleteOperator:function(){var c=this;var a=this.getSelectionModel().getSelection()[0];var b=a.raw.name;OperatorAction.canRestorePassword(function(d){if(d.success){Ext.Msg.confirm("确认","注销无可逆性,请慎重操作！确认要注销吗？",function(f){if(f=="yes"){var e=a.raw.id;OperatorAction.deleteOperator(e,function(g){if(g.success){c.refresh()}else{Ext.Msg.error(g.message)}})}},this)}else{Ext.Msg.error(d.message)}})}});Ext.define("VIP.shop.model.Shop",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"discountDescription",type:"string"},{name:"chargeWays",type:"string"},{name:"contactName",type:"string"},{name:"telephone",type:"string"},{name:"smsLimit",type:"string"},{name:"state",type:"string"}]});Ext.define("VIP.shop.store.Shop",{extend:VIP.store.BaseStore,model:"VIP.shop.model.Shop",sorters:[],remoteSort:true,pageSize:50,proxy:{type:"direct",directFn:"ShopAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.shop.AddShopWindow",{extend:Ext.window.Window,alias:["widget.addshopwindow"],layout:"fit",width:640,icon:"images/shop_management.png",height:280,title:"添加店铺",modal:true,border:false,resizable:false,createView:function(){},createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.saveShop()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 100%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"textfield",fieldLabel:"店铺名",name:"name",itemId:"name",vtype:"stringblank",maxLength:"15",maxLengthText:"不可超过15位",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#contactName").focus(true)}},delay:200}}},,{xtype:"fieldcontainer",fieldLabel:"收费方式",allowBlank:false,border:false,defaultType:"checkbox",layout:"hbox",columns:3,items:[{margin:"0 5",boxLabel:"现金",name:"chargeWays",checked:true,inputValue:"现金"},{margin:"0 5",boxLabel:"支票",name:"chargeWays",inputValue:"支票"},{margin:"0 5",boxLabel:"刷卡",name:"chargeWays",inputValue:"刷卡"}]},{xtype:"textfield",fieldLabel:"联系人",itemId:"contactName",name:"contactName",allowBlank:false,vtype:"stringblank",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#telephone").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"联系电话",name:"telephone",itemId:"telephone",allowBlank:false,regex:/^1[3|4|5|8][0-9]{9}$/,regexText:"无效的手机号码",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.saveShop()}},delay:200}}}]}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);setTimeout(function(){a.down("#name").focus(true)},500)},addListeners:function(){},saveShop:function(d){var f=this;var e=this.down("vipform").getForm();if(e.isValid()){var b=e.getValues();var a=[b.chargeWays];var g="";for(var c=0;c<a.length;c++){g+=a[c];if(c<(a.length-1)){g+=","}}if(g=="undefined"){Ext.Msg.info("至少需选择一种收费方式！");return false}else{b.chargeWays=g;ShopAction.addShop(b,function(h){if(h.success){Ext.Msg.info("添加成功.",function(){if(f.onSave){f.onSave.fn.call(f.onSave.scope)}f.destroy()})}else{Ext.Msg.error(h.message)}})}}}});Ext.define("VIP.shop.EditShopWindow",{extend:Ext.window.Window,alias:["widget.editshopwindow"],layout:"fit",width:640,icon:"images/shop_management.png",height:280,title:"修改店铺",modal:true,resizable:false,border:false,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.saveShop()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 100%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"textfield",fieldLabel:"店铺名",name:"name",maxLength:"15",maxLengthText:"不可超过15位",vtype:"stringblank",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#contactName").focus(true)}},delay:200}}},{xtype:"fieldcontainer",fieldLabel:"收费方式",allowBlank:false,border:false,defaultType:"checkbox",layout:"hbox",columns:3,items:[{margin:"0 5",boxLabel:"现金",name:"chargeWays",itemId:"xj",checked:true,inputValue:"现金"},{margin:"0 5",boxLabel:"支票",itemId:"zp",name:"chargeWays",inputValue:"支票"},{margin:"0 5",boxLabel:"刷卡",itemId:"sk",name:"chargeWays",inputValue:"刷卡"}]},{xtype:"textfield",fieldLabel:"联系人",name:"contactName",itemId:"contactName",vtype:"stringblank",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#telephone").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"联系电话",name:"telephone",itemId:"telephone",allowBlank:false,regex:/^1[3|4|5|8][0-9]{9}$/,regexText:"无效的手机号码",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.saveShop()}},delay:200}}},{fieldLabel:"状态",xtype:"vcombo",name:"state",itemId:"state",options:[{text:"正常",value:"1"},{text:"冻结",value:"0"},{text:"注销",value:"-2"}],allowBlank:false,listeners:{change:{fn:function(f,c,d){var e=f.getValue();if(e=="0"){if(b.params.shopId==1){Ext.Msg.error("总店无法冻结！",function(){b.down("#state").setValue("1")})}}if(e=="-2"){if(b.params.shopId==1){Ext.Msg.error("总店无法注销！",function(){b.down("#state").setValue("1")})}else{Ext.Msg.info("注销无可逆性,请慎重操作！")}}},delay:200}}}]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},addListeners:function(){},load:function(){var a=this;ShopAction.getShop({shopId:this.params.shopId},function(c){a.down("vipform").getForm().setValues(c.data);var d=c.data.chargeWays;var e=d.split(",");for(var b=0;b<e.length;b++){if(e[b]=="现金"){a.down("#xj").setValue(true)}else{if(e[b]=="支票"){a.down("#zp").setValue(true)}else{if(e[b]=="刷卡"){a.down("#sk").setValue(true)}}}}})},saveShop:function(){var e=this;var d=this.down("vipform").getForm();if(d.isValid()){var b=d.getValues();var a=[b.chargeWays];var f="";if(a!=null){for(var c=0;c<a.length;c++){f+=a[c];if(c<(a.length-1)){f+=","}}}if(f=="undefined"){Ext.Msg.info("至少需选择一种收费方式！");return false}else{b.chargeWays=f;ShopAction.editShop(Ext.apply({shopId:this.params.shopId},b),function(g){if(g.success){Ext.Msg.info("修改成功.",function(){if(e.onSave){e.onSave.fn.call(e.onSave.scope)}e.destroy()})}else{Ext.Msg.error(g.message)}})}}}});Ext.define("VIP.shop.ShopGrid",{extend:Ext.grid.Panel,xtype:"shopgrid",layout:"fit",title:"连锁分店管理",icon:"images/shop_management.png",columns:[{xtype:"rownumberer",width:50,align:"center",text:"序列",sortable:false},{text:"店铺名称",dataIndex:"name",flex:2},{text:"收费方式",dataIndex:"chargeWays",flex:1},{text:"联系人",dataIndex:"contactName",flex:1},{text:"联系电话",dataIndex:"telephone",flex:2},{text:"状态",dataIndex:"state",flex:1,renderer:function(b,a){if(b==1){a.style="color:#0f0";return"正常"}else{if(b==0){a.style="color:#00f";return"冻结"}else{if(b==-2){a.style="color:#f00";return"注销"}else{return b}}}}}],createDockedItems:function(a){var b=this;var d={xtype:"toolbar",dock:"top",items:[{xtype:"vcombo",emptyText:"选择状态",fieldLabel:"状态",labelWidth:30,width:125,margin:"0 5 0 10",itemId:"state",options:[{text:"全部",value:""},{text:"正常",value:"1"},{text:"冻结",value:"0"}]},{xtype:"button",icon:"images/search-16.png",text:"搜索",width:70,handler:function(e){e.up("shopgrid").doSearch()}},"->","-",{xtype:"button",icon:"images/add.png",width:80,text:"增加",handler:function(e){e.up("shopgrid").addShop()}},"-",{xtype:"button",icon:"images/edit.png",width:80,itemId:"edit",text:"修改",disabled:true,handler:function(e){e.up("shopgrid").editShop()}}]};var c={xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return[d,c]},createStore:function(){var a=Ext.create("VIP.shop.store.Shop");return a},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.callParent(arguments);a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.resetButtonStatus,this);this.on("itemdblclick",this.editShop,this)},doSearch:function(){var a=this.down("#state").getValue();var b=this.getStore().getProxy().extraParams;if(!b){b={};this.getStore().getProxy().extraParams=b}if(a!=""){b.state=a}else{delete b.state}this.getStore().loadPage(1)},refresh:function(){this.getStore().reload()},resetButtonStatus:function(b,c){if(c.length==1){var a=this.getSelectionModel().getSelection()[0];this.down("#edit").setDisabled(false)}},addShop:function(){var a=this;ShopAction.canAddShop(function(b){if(b.success){var c=Ext.create("VIP.shop.AddShopWindow",{onSave:{fn:a.refresh,scope:a}});c.show()}else{Ext.Msg.error(b.message)}})},editShop:function(){var a=this;ShopAction.canAddShop(function(b){if(b.success){var c=a.getSelectionModel().getSelection()[0];var d=c.data.id;var e=Ext.create("VIP.shop.EditShopWindow",{params:{shopId:d},onSave:{fn:a.refresh,scope:a}});e.show()}else{Ext.Msg.error(b.message)}})},deleteShop:function(){var c=this;var a=this.getSelectionModel().getSelection()[0];var b=a.raw.name;Ext.Msg.confirm("确认","确认要删除店铺["+b+"] 吗？",function(e){if(e=="yes"){var d=a.raw.id;ShopAction.deleteShop({shopId:d},function(f){if(f.success){c.refresh()}else{Ext.Msg.error(f.message)}})}},this)}});Ext.define("VIP.security.model.OperatorRule",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"actions",type:"string"},{name:"actionsStr",type:"string"},{name:"description",type:"string"}]});Ext.define("VIP.security.store.OperatorRule",{extend:VIP.store.BaseStore,model:"VIP.security.model.OperatorRule",sorters:[],remoteSort:true,pageSize:50,proxy:{type:"direct",directFn:"OperatorRuleAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.security.OperatorRuleGrid",{extend:Ext.grid.Panel,alias:["widget.operatorrulegrid"],title:"",layout:"fit",title:"管理员角色设置",icon:"images/manage_role.png",columns:[{xtype:"rownumberer",width:50,align:"center",text:"序列",sortable:false},{text:"名称",dataIndex:"name",flex:1},{text:"权限",dataIndex:"actionsStr",flex:4},{text:"描述",dataIndex:"description",flex:3}],createStore:function(){var a=Ext.create("VIP.security.store.OperatorRule");return a},createDockedItems:function(a){var c={xtype:"toolbar",dock:"top",items:["->",{xtype:"button",text:"添加",icon:"images/add.png",width:80,handler:function(d){d.up("operatorrulegrid").addRule()}},"-",{xtype:"button",text:"修改",icon:"images/edit.png",width:80,itemId:"edit",disabled:true,handler:function(d){d.up("operatorrulegrid").editRule()}},"-",{xtype:"button",text:"删除",icon:"images/delete.png",width:80,itemId:"delete",disabled:true,handler:function(d){d.up("operatorrulegrid").deleteRule()}}]};var b={xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return[c,b]},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.callParent(arguments);a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.resetButtonStatus,this);this.on("itemdblclick",this.editRule,this)},doSearch:function(){var a=this.getStore().getProxy().extraParams;if(!a){a={};this.getStore().getProxy().extraParams=a}this.getStore().loadPage(1)},refresh:function(){this.getStore().reload()},resetButtonStatus:function(b,c){if(c.length==1){var a=this.getSelectionModel().getSelection()[0];var d=a.raw.id;this.down("#edit").setDisabled(d==1);this.down("#delete").setDisabled(d==1)}else{this.down("#edit").setDisabled(false);this.down("#delete").setDisabled(false)}},addRule:function(){var a=this;OperatorRuleAction.canAddRule(function(b){if(b.success){var c=Ext.create("VIP.security.OperatorRuleWindow",{onSave:{fn:a.refresh,scope:a}});c.show()}else{Ext.Msg.error(b.message)}})},editRule:function(){var a=this;OperatorRuleAction.canEditRule(function(b){if(b.success){var c=a.getSelectionModel().getSelection()[0];var d=c.raw.id;if(d!=1){var e=Ext.create("VIP.security.OperatorRuleWindow",{params:{ruleId:d},onSave:{fn:a.refresh,scope:a}});e.show()}}else{Ext.Msg.error(b.message)}})},deleteRule:function(){var c=this;var a=this.getSelectionModel().getSelection()[0];var b=a.raw.name;OperatorRuleAction.canEditRule(function(d){if(d.success){Ext.Msg.confirm("确认","确认要删除权限组 ["+b+"] 吗？",function(f){if(f=="yes"){var e=a.raw.id;OperatorRuleAction.deleteRule({ruleId:e},function(g){if(g.success){c.refresh()}else{Ext.Msg.error(g.message)}})}},this)}else{Ext.Msg.error(d.message)}})}});Ext.define("VIP.system.model.MembershipType",{extend:Ext.data.Model,fields:[{name:"vipCardTypeId",type:"string"},{name:"vipCardTypeName",type:"string"},{name:"moneyBackRate",type:"string"},{name:"discountRate",type:"string"},{name:"isDefault",type:"boolean"},{name:"pointRate",type:"string"}]});Ext.define("VIP.system.store.MembershipType",{extend:VIP.store.BaseStore,model:"VIP.system.model.MembershipType",sorters:[],remoteSort:true,pageSize:50,proxy:{type:"direct",directFn:"MembershipTypeAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.system.AddMembershipTypeWindow",{extend:Ext.window.Window,alias:["widget.addmembershiptypewindow"],layout:"fit",width:640,height:280,title:"添加会员类别",modal:true,resizable:false,border:false,icon:"images/level_management.png",createView:function(){},createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.saveMembershipType()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 100%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"textfield",fieldLabel:"类别名称",name:"membershipTypeName",itemId:"membershipTypeName",vtype:"stringblank",maxLength:"15",maxLengthText:"不可超过15位",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#moneyBackRate").focus(true)}},delay:200}}},{xtype:"numberfield",fieldLabel:"充值返现百分比",name:"moneyBackRate",itemId:"moneyBackRate",allowBlank:false,maxValue:100,minValue:0,value:0,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#discountRate").focus(true)}},delay:200}}},{xtype:"numberfield",fieldLabel:"折扣百分比",name:"discountRate",itemId:"discountRate",allowBlank:false,value:0,maxValue:100,minValue:0,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.saveMembershipType()}},delay:200}}},{xtype:"numberfield",fieldLabel:"积分百分比",name:"pointRate",itemId:"pointRate",allowBlank:false,value:0,minValue:0,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.saveMembershipType()}},delay:200}}}]}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);setTimeout(function(){a.down("#membershipTypeName").focus(true)},500)},addListeners:function(){},saveMembershipType:function(b){var d=this;var c=this.down("vipform").getForm();if(c.isValid()){var a=c.getValues();MembershipTypeAction.addMembershipType(a,function(e){if(e.success){Ext.Msg.info("添加成功.",function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.destroy()})}else{Ext.Msg.error(e.message)}})}}});Ext.define("VIP.system.EditMembershipTypeWindow",{extend:Ext.window.Window,alias:["widget.editmembershiptypewindow"],layout:"fit",width:640,height:280,title:"修改卡片",modal:true,resizable:false,border:false,icon:"images/level_management.png",createView:function(){},createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.saveMembershipType()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 100%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"textfield",fieldLabel:"类别名称",name:"membershipTypeName",vtype:"stringblank",maxLength:"15",maxLengthText:"不可超过15位",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#moneyBackRate").focus(true)}},delay:200}}},{xtype:"numberfield",fieldLabel:"充值返现百分比",name:"moneyBackRate",itemId:"moneyBackRate",allowBlank:false,maxValue:100,minValue:0,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#discountRate").focus(true)}},delay:200}}},{xtype:"numberfield",fieldLabel:"折扣百分比",name:"discountRate",itemId:"discountRate",allowBlank:false,maxValue:100,minValue:0,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.saveMembershipType()}},delay:200}}},{xtype:"numberfield",fieldLabel:"积分百分比",name:"pointRate",itemId:"pointRate",allowBlank:false,value:0,minValue:0,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.saveMembershipType()}},delay:200}}}]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},addListeners:function(){},load:function(){var a=this;MembershipTypeAction.getMembershipTypeById(a.params.membershipTypeId,function(b){a.down("vipform").getForm().setValues(b.data)})},saveMembershipType:function(b){var d=this;var c=this.down("vipform").getForm();if(c.isValid()){var a=c.getValues();MembershipTypeAction.editMembershipType(d.params.membershipTypeId,a,function(e){if(e.success){Ext.Msg.info("修改成功.",function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.destroy()})}else{Ext.Msg.error(e.message)}})}}});Ext.define("VIP.member.ChangeMemberType",{extend:Ext.window.Window,alias:["widget.changemembertypeup"],title:"更改会员等级",modal:true,resizable:false,frame:true,width:400,height:200,layout:"fit",padding:10,createView:function(){var b=this;var a=[{xtype:"form",border:false,bodyPadding:10,fieldDefaults:{width:300,labelWidth:120,labelAlign:"right",margin:"10 0 0 0"},items:[{xtype:"vcombo",fieldLabel:"会员等级",name:"membershipTypeId",itemId:"membershipTypeId",getProxy:function(){return{type:"direct",directFn:"MembershipTypeAction.listAsOption"}},listeners:{change:{fn:function(e,d,c){MembershipTypeAction.getMembershipTypeById(d,function(f){var g=f.data;b.down("#discountRate").setValue(g.discountRate+"%");b.down("#moneyBackRate").setValue(g.moneyBackRate+"%")})}},optionsready:{fn:function(c){if(b.membershipTypeId){c.setValue(b.membershipTypeId)}}}}},{xtype:"displayfield",fieldLabel:"折扣百分比",name:"discountRate",itemId:"discountRate",fieldStyle:"font-size:12pt; color:green;font-weight:bold;"},{xtype:"displayfield",fieldLabel:"返现百分比",name:"moneyBackRate",itemId:"moneyBackRate",fieldStyle:"font-size:12pt; color:#FF9912;font-weight:bold;"}]}];return a},createButtons:function(){var b=this;var a=[{text:"确定",icon:"images/update.png",itemId:"search",handler:function(c){var d=b.down("#membershipTypeId").getValue();if(d==null){Ext.Msg.error("请选择会员类型");return}var e={userIds:b.userIds,membershipTypeId:d};MemberAction.changeMembershipTypeForMembers(e,function(f){if(f.success){Ext.Msg.info("修改成功",function(){if(b.onSave){b.close();b.onSave.fn.call(b.onSave.scope)}})}else{Ext.Msg.error("修改失败")}})}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)}});Ext.define("VIP.system.MembershipTypeGrid",{extend:Ext.grid.Panel,xtype:"membershiptypegrid",layout:"fit",title:"会员等级维护",icon:"images/level_management.png",columns:[{xtype:"rownumberer",width:50,align:"center",text:"序列",sortable:false},{text:"类别名称",dataIndex:"vipCardTypeName",flex:2},{text:"充值返现百分比",dataIndex:"moneyBackRate",flex:1,renderer:function(b,a){return b+"%"}},{text:"折扣百分比",dataIndex:"discountRate",flex:2,renderer:function(b,a){return b+"%"}},{text:"积分百分比",dataIndex:"pointRate",flex:2,renderer:function(b,a){return b+"%"}},{text:"是否为默认",dataIndex:"isDefault",flex:1,renderer:function(b,a){if(b==true){a.style="color:#00FF00";return"√"}else{return""}}}],createDockedItems:function(a){var b=this;var d={xtype:"toolbar",dock:"top",items:["->",{xtype:"button",width:100,icon:"images/update.png",itemId:"default",text:"设为默认",disabled:true,handler:function(f){var e=b.getSelectionModel().getSelection()[0].raw.vipCardTypeName;b.defaultdMembershpType(e)}},"-",{xtype:"button",icon:"images/add.png",width:80,text:"增加",handler:function(e){b.addMembershipType()}},"-",{xtype:"button",icon:"images/edit.png",width:80,itemId:"edit",text:"修改",disabled:true,handler:function(e){b.editMembershipType()}},"-",{xtype:"button",icon:"images/delete.png",width:80,itemId:"delete",text:"删除",disabled:true,handler:function(e){b.deleteMembershipType()}}]};var c={xtype:"pagingtoolbar",dock:"bottom",store:a,displayInfo:true,emptyMsg:"没有查询到数据"};return[d,c]},createStore:function(){var a=Ext.create("VIP.system.store.MembershipType");return a},initComponent:function(){var a=this.createStore();Ext.apply(this,{store:a,dockedItems:this.createDockedItems(a)});this.callParent(arguments);a.on("load",function(){var b=this.getStore().getProxy().getReader().rawData;if(!b.success){Ext.Msg.error(b.message)}},this);this.on("selectionchange",this.resetButtonStatus,this);this.on("itemdblclick",this.editMembershipType,this)},doSearch:function(){var a=this.getStore().getProxy().extraParams;if(!a){a={};this.getStore().getProxy().extraParams=a}this.getStore().loadPage(1)},refresh:function(){this.getStore().reload()},resetButtonStatus:function(b,c){if(c.length==1){var a=this.getSelectionModel().getSelection()[0].raw.isDefault;this.down("#edit").setDisabled(false);if(a=="false"){this.down("#delete").setDisabled(false);this.down("#default").setDisabled(false)}else{this.down("#delete").setDisabled(true);this.down("#default").setDisabled(true)}}},addMembershipType:function(){var a=this;MembershipTypeAction.canAddMembershipType(function(b){if(b.success){var c=Ext.create("VIP.system.AddMembershipTypeWindow",{onSave:{fn:a.refresh,scope:a}});c.show()}else{Ext.Msg.error(b.message)}})},editMembershipType:function(){var a=this;MembershipTypeAction.canEditMembershipType(function(b){if(b.success){var c=a.getSelectionModel().getSelection()[0];var d=c.raw.vipCardTypeId;var e=Ext.create("VIP.system.EditMembershipTypeWindow",{params:{membershipTypeId:d},onSave:{fn:a.refresh,scope:a}});e.show()}else{Ext.Msg.error(b.message)}})},defaultdMembershpType:function(b){var d=this;var a=this.getSelectionModel().getSelection()[0];var c=a.raw.vipCardTypeId;MembershipTypeAction.canDeleteMembershipType(function(e){if(e.success){Ext.Msg.confirm("提示","确认将【"+b+"】设为默认等级！",function(f){if(f=="yes"){MembershipTypeAction.setDefaultMembershipType(c,function(g){if(g.success){d.refresh()}else{Ext.Msg.error(g.message)}})}})}else{Ext.Msg.error(e.message)}})},deleteMembershipType:function(){var d=this;var a=this.getSelectionModel().getSelection()[0];var b=a.raw.vipCardTypeName;var c=a.raw.vipCardTypeId;MembershipTypeAction.canDeleteMembershipType(function(e){if(e.success){MembershipTypeAction.countAllUsersForMembershipType(c,function(f){var h=f.data.memberNumber;if(h>0){var g=Ext.create("VIP.system.DeleteMembershipTypeWindow",{params:{membershipTypeId:c,membershipNumber:h},onSave:{fn:d.refresh,scope:d}});g.show()}else{Ext.Msg.confirm("确认","确认要删除会员种类["+b+"] 吗？",function(i){if(i=="yes"){MembershipTypeAction.deleteMembershipTypeById(c,null,function(j){if(j.success){d.refresh()}else{Ext.Msg.error(j.message)}})}},this)}})}else{Ext.Msg.error(e.message)}})}});Ext.define("VIP.system.SystemSettings",{extend:Ext.panel.Panel,alias:["widget.systemsettings"],requires:[],icon:"images/system_management.png",title:"系统参数设置",defaults:{},createView:function(){var b=this;var a=[{xtype:"form",border:false,layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"fieldset",title:"积分兑现设置",width:"98%",margin:5,items:[{xtype:"numberfield",name:"pointMoneyRate",itemId:"pointMoneyRate",fieldLabel:"积分兑现百分比",margin:10,value:0,maxValue:100,minValue:0}]},{xtype:"button",text:"保存设置",width:150,height:40,handler:function(){Ext.Msg.alert("提示","保存设置")}}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView()});this.callParent(arguments);this.load()},load:function(){var a=this;ConfigurationAction.getConfigur(function(b){a.down("#pointMoneyRate").setValue(b.data.pointMoneyRate)})},save:function(){var c=this.getForm();var b=this;if(c.isValid()){var a=this.getValues();ConfigurationAction.setConfigur(a,function(d){})}}});Ext.define("VIP.west.Configuration",{extend:Ext.panel.Panel,alias:["widget.vipwestconfiguration"],title:"系统设置",iconCls:"west-configuration",defaults:{xtype:"link"},layout:{type:"vbox",align:"stretch"},createItems:function(){var c=this;var b=function(d){c.handleAction.call(c,d.text,d.itemId)};var a=[{text:"系统参数设置",icon:"images/system_management.png",itemId:"system",handler:b},{text:"连锁分店管理",icon:"images/shop_management.png",itemId:"shop",handler:b},{text:"操作员管理",icon:"images/operator_management.png",itemId:"operator",handler:b},{text:"管理员角色设置",itemId:"manageRole",icon:"images/manage_role.png",handler:b},{text:"会员等级维护",itemId:"level",icon:"images/level_management.png",handler:b}];return a},initComponent:function(){Ext.apply(this,{items:this.createItems()});this.callParent(arguments)},handleAction:function(b,c){var a=this;vip.viewport.main.removeAll();a.up().changeLink(c);if(b=="系统参数设置"){vip.viewport.main.setContent({xtype:"systemsettings"})}else{if(b=="操作员管理"){OperatorAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"operatorgrid"})}else{Ext.Msg.error(d.message)}})}else{if(b=="连锁分店管理"){ShopAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"shopgrid"})}else{Ext.Msg.error(d.message)}})}else{if(b=="管理员角色设置"){OperatorRuleAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"operatorrulegrid"})}else{Ext.Msg.error(d.message)}})}else{if(b=="会员等级维护"){MembershipTypeAction.canList(function(d){if(d.success){vip.viewport.main.setContent({xtype:"membershiptypegrid"})}else{Ext.Msg.error(d.message)}})}}}}}}});Ext.define("VIP.west.Main",{extend:Ext.panel.Panel,alias:["widget.vipwestmain"],id:"west",region:"west",split:true,width:210,title:"功能列表",item:null,titleCollapse:true,collapsible:true,collapsed:false,layout:{type:"accordion",hideCollapseTool:true,titleCollapse:true,animate:true,multi:false},defaults:{autoScroll:true},items:[{xtype:"vipwestwelcome"},{xtype:"vipwestmembermanage"},{xtype:"vipwestreports"},{xtype:"vipwestmessage",hidden:window.localStorage.getItem("allowPublishCoupons")=="false"&&window.localStorage.getItem("allowPublishMessages")=="false"},{xtype:"vipwestconfiguration"}],listeners:{render:function(a){}},initComponent:function(){this.callParent(arguments)},changeLink:function(b){var a=this;if(a.item!=null){a.down("#"+a.item).removeCls("link-visited")}a.down("#"+b).addCls("link-visited");a.item=b}});Ext.define("VIP.Main",{extend:Ext.panel.Panel,alias:["widget.vipmain"],requires:[],id:"main",region:"center",layout:"card",defaults:{border:false,closable:true},items:[{xtype:"welcomesummary"}],initComponent:function(){this.callParent(arguments)},setContent:function(a){this.removeAll();this.add(a)}});Ext.define("VIP.Center",{extend:Ext.panel.Panel,alias:["widget.vipcenter"],id:"main_center",region:"center",layout:"border",border:false,defaults:{},items:[{xtype:"vipwestmain"},{xtype:"vipmain"}],initComponent:function(){this.callParent(arguments)}});Ext.define("VIP.operator.OperatorInfoWindow",{extend:Ext.window.Window,alias:["widget.operatorinfowindow"],layout:"fit",width:640,height:280,modal:true,resizable:false,border:false,icon:"images/my_info.png",createButtons:function(){var b=this;var a=[{text:"修改",icon:"images/update.png",handler:function(c){b.updatePassword()}},{text:"取消",icon:"images/cancel.png",handler:function(c){b.close()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 50%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"displayfield",fieldLabel:"操作帐号",itemId:"accountName"},{xtype:"displayfield",fieldLabel:"角色名称",itemId:"ruleName"},{xtype:"displayfield",fieldLabel:"管理店铺",itemId:"shopName"}]},{xtype:"fieldset",title:"密码修改",anchor:"100% 50%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"textfield",fieldLabel:"原始密码",inputType:"password",allowBlank:false,itemId:"originalPassword",colspan:2,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#password").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"新密码",inputType:"password",itemId:"password",allowBlank:false,vtype:"password",labelStyle:"color:red",initialPassField:"passwordAg",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#passwordAg").focus(true)}},delay:200}}},{xtype:"textfield",fieldLabel:"确认密码",itemId:"passwordAg",inputType:"password",allowBlank:false,vtype:"password",initialPassField:"password",labelStyle:"color:red",listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.updatePassword()}},delay:200}}}]}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load();setTimeout(function(){a.down("#originalPassword").focus(true)},500)},updatePassword:function(){var b=this;if(b.down("#originalPassword").getValue()==""){b.down("#originalPassword").markInvalid("原密码为空");return false}if(b.down("#password").getValue()!=b.down("#passwordAg").getValue()){b.down("#password").markInvalid("二次密码不一致");b.down("#passwordAg").markInvalid("二次密码不一致");return false}var a=window.operator.operatorId+"";var c=b.down("#originalPassword").getValue();var d=b.down("#password").getValue();if(a!=""&&c!=""&&d!=""){OperatorAction.changePassword(a,c,d,function(e){if(e.success){Ext.Msg.info("修改成功.",function(){b.close()})}else{Ext.Msg.error(e.message)}})}else{Ext.Msg.error("请输入正确的值.")}},load:function(){var a=this;a.down("#shopName").setValue(window.operator.shopName);a.down("#accountName").setValue(window.operator.accountName);a.down("#ruleName").setValue(window.operator.ruleName)}});Ext.define("VIP.TopBar",{extend:Ext.toolbar.Toolbar,alias:["widget.viptopbar"],border:"false",region:"north",id:"topbar",defaults:{scale:"large",iconAlign:"top"},layout:{overflowHandler:"Menu"},createTopBarItems:function(){var b=this;var a=[{xtype:"button",text:"消费",width:80,icon:"images/consume.png",handler:function(c){var d=vip.viewport.west.down("vipwestmembermanage");d.expand();setTimeout(function(){d.handleAction("消费","consume")},400)}},"-",{xtype:"button",text:"充值",width:80,icon:"images/deposit.png",handler:function(d){var c=vip.viewport.west.down("vipwestmembermanage");c.expand();setTimeout(function(){c.handleAction("充值","deposit")},400)}},"-",{xtype:"button",text:"会员档案",width:80,icon:"images/member_info.png",handler:function(d){var c=vip.viewport.west.down("vipwestmembermanage");c.expand();setTimeout(function(){c.handleAction("会员档案","member")},400)}},"->","-",{xtype:"button",padding:"2 5 2 5",icon:"images/manage.png",iconAlign:"left",scale:"medium",text:'你好  <span style="font-weight:bold">'+window.operator.operatorName+"</span> （"+window.operator.ruleName+"）",menu:{xtype:"menu",items:[{text:"我的帐号",icon:"images/my_info.png",handler:function(){b.showMyInfo()}}]}},"-",{text:"退出",icon:"images/sign_out.png",iconAlign:"left",scale:"medium",handler:function(){Ext.MessageBox.confirm("警告","你确定你要退出吗？",function(c){if(c=="yes"){SignAction.signOut(function(d){if(d.success){window.location.reload(true)}else{}})}})}}];return a},showMyInfo:function(){var a=Ext.create("VIP.operator.OperatorInfoWindow",{title:window.operator.operatorName});a.show()},initComponent:function(){Ext.apply(this,{items:this.createTopBarItems()});this.callParent(arguments)}});Ext.define("VIP.Viewport",{extend:Ext.Viewport,alias:["widget.vipviewport"],layout:"border",initComponent:function(){this.callParent(arguments)},items:[{xtype:"viptopbar"},{xtype:"vipcenter"}]});Ext.define("VIP.common.LoginWindow",{extend:Ext.window.Window,xtype:"loginwindow",plain:true,header:false,border:false,closable:false,draggable:false,frame:false,resizable:false,margin:0,padding:0,width:420,createView:function(){var b=this;var a=[{xtype:"form",region:"center",border:false,layout:{type:"vbox",align:"left",pack:"center"},items:[{xtype:"panel",region:"center",margin:"20 0 5 0",border:false,layout:{type:"hbox",align:"left",pack:"center"},items:[{xtype:"label",text:"登录",margin:"0 5 5 70",style:{fontFamily:"微软雅黑",fontSize:"26px",color:"#434343"}},{xtype:"label",text:"魔客会员营销管理系统",margin:"15 5 5 10",style:{fontSize:"13px",fontFamily:"微软雅黑",color:"#434343"}}]},{border:false,xtype:"box",width:"100%",html:'<div style="text-align:center;color:#666;">::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</div>'},{xtype:"panel",margin:"5 0 0 0",border:false,layout:{type:"hbox"},items:[{xtype:"label",text:"用户名:",margin:"30 0 0 50",style:{fontSize:"13px",fontFamily:"宋体",color:"#000"}},{xtype:"textfield",allowBlank:false,labelAlign:"left",name:"accountName",itemId:"accountName",margin:"20 5 5 20",emptyText:"用户名",value:"",height:35,width:250,selectOnFocus:true,listeners:{afterrender:{fn:function(){this.focus()},delay:500},specialKey:function(d,c){if(c.keyCode==13){setTimeout(function(){b.down("#password").focus(true)},100)}}}}]},{xtype:"panel",margin:"10 0 10 0",border:false,layout:{type:"hbox"},items:[{xtype:"label",text:"密　码:",margin:"20 0 0 50",style:{fontSize:"13px",fontFamily:"宋体",color:"#000"}},{xtype:"textfield",allowBlank:false,itemId:"password",name:"password",margin:"10 5 5 20",emptyText:"密　码",height:35,inputType:"password",value:"",width:250,selectOnFocus:true,listeners:{specialKey:function(d,c){if(c.keyCode==13){b.signIn()}}}}]},{border:false,margin:"10 5 5 115",padding:"0 0 5 0",layout:{type:"hbox",align:"left",pack:"center"},items:[{xtype:"button",text:'<font color="#fff" style="font-size:14px;font-family:\'宋体\';">登录</font>',width:250,margin:"0 5 0 0",style:{background:"#299816",color:"#fff"},padding:"10 5",handler:function(c){b.signIn()}}]},{xtype:"label",margin:"0 0 35 280",html:'<a href="admin/index.html" class="fontlink">Admin登录界面</a>'}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView()});this.callParent(arguments)},signIn:function(){var c=this;c.setLoading("登录中...");var b=c.down("form").getForm();var a=b.getValues();a.password=base64encode(a.password);if(b.isValid()){OperatorAction.login(domainPrefix,a.accountName,a.password,function(d){c.setLoading(false);if(d.success){window.operator=d.data.operator;window.contextPath=d.data.contextPath;window.localStorage.setItem("allowPublishCoupons",d.data.allowPublishCoupons);window.localStorage.setItem("allowPublishMessages",d.data.allowPublishMessages);window.location.reload()}else{Ext.Msg.info(d.message,function(){setTimeout(function(){c.down("#accountName").focus(true)},100)})}})}else{if(a.accountName==null||a.accountName==""){Ext.Msg.info("请输入管理员帐号")}else{if(a.password==null||a.password==""){Ext.Msg.info("请输入管理员密码")}}c.setLoading(false)}}});Ext.define("VIP.common.SignInViewport",{extend:Ext.Viewport,xtype:"signinform",layout:"fit",createView:function(){var b=this;var a=[{xtype:"panel",border:false,width:"100%",layout:"anchor",items:[{xtype:"box",height:"103px",anchor:"100%",html:'<div style="background-image: -moz-linear-gradient(top, #8fa1ff, #013879);background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #8fa1ff), color-stop(1, #013879));filter: progid:DXImageTransform.Microsoft.gradient( startColorstr=#8fa1ff, endColorstr=#013879,GradientType=0 );background: -ms-linear-gradient(top, #8fa1ff 0%, #013879 100%);height:100%;"><img style="line-height:100%" src="images/login-picture.png "></div><div style="background-image: url(\'images/world-wallpaper.jpg\');background-repeat: repeat-x; height: 3px"></div>'},{xtype:"box",anchor:"100% -193px",html:'<div style="position: absolute; z-index: 999; top:20%; left:20%"><p style="font-family:\'微软雅黑\';font-Size:26px;color:#434343">魔客会员管理系统</p><p style="font-family:\'微软雅黑\';font-Size:13px;color:#434343">魔客会员管理系统用科学的方法给您带来无限的效益</p></div><img style="width:100%;height:100%" src="images/world-wallpaper.jpg ">'},{xtype:"box",height:"90px",anchor:"100%",html:'<div style="text-align: center;padding-top:20px;"><a href="http://www.vipmonk.com" style="text-decoration: none; color: #000;">产品主页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.vipmonk.com" style="text-decoration: none; color: #000;">公司主页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.vipmonk.com" style="text-decoration: none; color: #000;">关于我们</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.vipmonk.com" style="text-decoration: none; color: #000;">联系我们</a><br/><p>昆明泽天科技  &copy;2013 All Rights Reserved</p></div>'}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView()});this.callParent(arguments);var a=Ext.create("VIP.common.LoginWindow");a.show();this.on("resize",function(b,e,d,c,f){if(e<500){a.setPosition(0,d*0.2)}else{a.setPosition(e-500,d*0.2)}},this)}});Ext.define("VIP.member.store.MemberInfo",{extend:VIP.store.BaseStore,model:"VIP.member.model.Member",sorters:[{property:"lastUpdateTime",direction:"DESC"}],proxy:{type:"direct",directFn:"MemberAction.getMemberById",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.member.model.ConsumeSummary",{extend:Ext.data.Model,fields:[{name:"year",type:"string"},{name:"month",type:"string"},{name:"yearMonth",type:"string"},{name:"consumeTotal",type:"number"}]});Ext.define("VIP.member.store.ConsumeSummary",{extend:VIP.store.BaseStore,model:"VIP.member.model.ConsumeSummary",sorters:[],proxy:{type:"direct",directFn:"MemberAction.getConsumeGroupByMonth",reader:{type:"json",root:"records"}},autoLoad:false});Ext.define("VIP.member.MemberConsumeSummaryChart",{extend:Ext.chart.Chart,alias:["widget.memberconsumesummarychart"],animate:true,shadow:true,axes:[{type:"Numeric",position:"left",fields:["consumeTotal"],title:"消费金额",grid:true,minimum:0},{type:"Category",position:"bottom",fields:["yearMonth"],title:""}],series:[{type:"column",axis:"left",highlight:true,tips:{trackMouse:true,width:140,height:28,renderer:function(b,a){this.setTitle(b.get("yearMonth")+": "+b.get("consumeTotal")+" 元")}},label:{display:"insideEnd",field:"consumeTotal",orientation:"horizental",color:"#333"},xField:"yearMonth",yField:"consumeTotal"}],background:{gradient:{id:"backgroundGradient",angle:45,stops:{0:{color:"#ffffff"},100:{color:"#eaf1f8"}}}},initComponent:function(){this.store=Ext.create("VIP.member.store.ConsumeSummary",{});this.callParent(arguments)},load:function(b){if(b){this.userId=b}var f=new Date();var c=f.getFullYear()+"";var e=f.getMonth()+1;if(e<10){e="0"+e}else{e+=""}var d="Y年m月d日";var a=Ext.Date.parse(c-1+"年"+e+"月01日",d);this.store.getProxy().extraParams={userId:this.userId,startDate:Ext.Date.format(a,d),endDate:Ext.Date.format(f,d)};this.store.load()}});Ext.define("VIP.member.Detail",{extend:VIP.widget.form.Panel,alias:["widget.detail"],title:"基本信息",layout:"fit",border:false,padding:"5 25 5 5",marking:null,createView:function(){var b=this;var a=[{xtype:"container",layout:{type:"vbox",align:"center"},defaults:{width:"100%"},items:[{xtype:"container",layout:{type:"hbox",align:"center"},defaults:{height:330},items:[{xtype:"fieldset",border:false,width:"35%",margin:5,layout:{type:"table",columns:1},defaultType:"displayfield",defaults:{labelAlign:"right",width:300,labelWidth:110,padding:1,labelStyle:"font-size:5pt",fieldStyle:"font-size:5pt;font-weight:bold;"},items:[{name:"userAccountName",fieldLabel:"会员Email"},{name:"userScreenName",fieldLabel:"会员昵称"},{xtype:"fieldcontainer",fieldLabel:"会员余额",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"currentDeposit",fieldStyle:"font-size:12pt; color:red;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"元"}]},{xtype:"fieldcontainer",fieldLabel:"总计消费",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"totalConsume",fieldStyle:"font-size:12pt;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"元"}]},{name:"membershipTypeName",fieldLabel:"会员等级"},{xtype:"fieldcontainer",fieldLabel:"折扣百分比",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"discountRate",fieldStyle:"font-size:12pt; color:green;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"%"}]},{xtype:"fieldcontainer",fieldLabel:"返现百分比",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"moneyBackRate",fieldStyle:"font-size:12pt; color:#FF9912;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"%"}]},{xtype:"fieldcontainer",fieldLabel:"积分百分比",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"",fieldStyle:"font-size:12pt; color:#FF9912;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"%"}]},{xtype:"fieldcontainer",fieldLabel:"积分兑现百分比",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"",fieldStyle:"font-size:12pt; color:#FF9912;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"%"}]},{xtype:"fieldcontainer",fieldLabel:"总积分",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"",fieldStyle:"font-size:12pt; color:#FF9912;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"分"}]},{xtype:"fieldcontainer",fieldLabel:"剩余积分",layout:{type:"hbox"},items:[{xtype:"displayfield",name:"",fieldStyle:"font-size:12pt; color:#FF9912;font-weight:bold;"},{xtype:"label",margin:"3 0 0 5",text:"分"}]}]},{xtype:"container",itemId:"chartcontainer",width:"65%",padding:"10 0 0 0",layout:"fit",items:[{xtype:"memberconsumesummarychart"}]}]},{xtype:"button",text:"更改会员等级",icon:"images/change_level.png",scale:"large",height:60,padding:10,cls:"big-button",hidden:b.marking==null?true:false,handler:function(){b.changeMemberType()}}]}];return a},changeMemberType:function(){var a=this;if(a.resultData.membershipTypeId==null){return}MemberAction.canChangeMembershipType(function(b){if(b.success){Ext.create("VIP.member.ChangeMemberType",{membershipTypeId:a.resultData.membershipTypeId,userIds:[a.resultData.userId],onSave:{fn:function(){a.load();if(a.onSave){a.onSave.fn.call(this.onSave.scope)}},scope:a}}).show()}else{Ext.Msg.error(b.message)}})},initComponent:function(){Ext.apply(this,{items:this.createView()});this.callParent(arguments)},load:function(a){var b=this;if(a){this.userId=a}MemberAction.getMemberById(this.userId,function(c){if(c.success){if(!b.isDestroyed){var d=c.data;b.resultData=d;b.getForm().setValues(d);b.down("memberconsumesummarychart").load(b.userId)}}else{Ext.Msg.error(c.message)}});if(b.onLoad){b.onLoad.fn.call(this.onLoad.scope)}}});Ext.define("VIP.member.DetailMain",{extend:Ext.tab.Panel,alias:["widget.detailmain"],tabPosition:"bottom",icon:"images/basic_info.png",userId:null,marking:null,createView:function(){var b=this;var a=[{xtype:"detail",userId:this.userId,icon:"images/basic_info.png",marking:b.marking,onSave:b.onSave,onLoad:b.onLoad,listeners:{activate:{fn:function(c){c.load(b.userId)},single:true}}},{xtype:"depositgrid",title:"充值记录",userId:this.userId,autoLoad:false,listeners:{activate:{fn:function(c){c.refresh()},single:true}}},{xtype:"withdrawhistorygrid",title:"取款记录",userId:this.userId,autoLoad:false,listeners:{activate:{fn:function(c){c.refresh()},single:true}}},{xtype:"consumegrid",title:"消费记录",userId:this.userId,autoLoad:false,listeners:{activate:{fn:function(c){c.refresh()},single:true}}}];return a},initComponent:function(){Ext.apply(this,{items:this.createView()});this.callParent(arguments)}});Ext.define("VIP.member.model.CashCouponManage",{extend:Ext.data.Model,fields:[{name:"target_number",type:"string"},{name:"content",type:"int"},{name:"time",type:"datetime"},{name:"operator_name",type:"string"},{name:"shop_name",type:"string"},{name:"phoneCount",type:"int"},{name:"smsCount",type:"int"}]});Ext.define("VIP.member.model.ConsumerMember",{extend:Ext.data.Model,fields:[{name:"target_number",type:"string"},{name:"content",type:"int"},{name:"time",type:"datetime"},{name:"operator_name",type:"string"},{name:"shop_name",type:"string"},{name:"phoneCount",type:"int"},{name:"smsCount",type:"int"}]});Ext.define("VIP.member.store.CashCouponManage",{extend:VIP.store.BaseStore,model:"VIP.member.model.CashCouponManage",proxy:{type:"direct",directFn:"DepositAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.member.store.ConsumerMember",{extend:VIP.store.BaseStore,model:"VIP.member.model.ConsumerMember",proxy:{type:"direct",directFn:"DepositAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.message.ChooseTemplate",{extend:Ext.window.Window,alias:["widget.choosetemplate"],layout:"fit",title:"选择短信模板",width:400,height:400,buttonAlign:"center",createView:function(){var b=this;var a=[{xtype:"staticsmscontent",isChose:true,setContent:b.setContent,onClose:{fn:function(){b.close()},scope:b}}];return a},initComponent:function(){Ext.apply(this,{items:this.createView()});this.callParent(arguments)}});Ext.define("VIP.message.EditCouponWindow",{extend:Ext.window.Window,alias:["widget.editcouponwindow"],icon:"images/promotion.png",layout:"fit",padding:5,title:"修改活动信息",modal:true,border:false,resizable:false,width:462,height:590,num:1,createButtons:function(){var b=this;var a=[{text:"添加描述",handler:function(){b.addDescription()}},{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.save()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,autoScroll:true,layout:{type:"table",columns:2},defaults:{labelWidth:60,labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:"标题",name:"title",colspan:2,width:400,maxLength:10,maxLengthText:"不可超过10字符",vtype:"stringblank",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#initDate").focus(true)}},delay:200}}},{xtype:"datefield",fieldLabel:"开始日期",name:"initDate",itemId:"initDate",allowBlank:false,vtype:"daterange",endDateField:"expireDate",width:195,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#expireDate").focus(true)}},delay:200}}},{xtype:"datefield",fieldLabel:"结束日期",name:"expireDate",itemId:"expireDate",minValue:new Date(),vtype:"daterange",startDateField:"initDate",width:195,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#content").focus(true)}},delay:200}}},,{xtype:"panel",itemId:"description",border:false,colspan:2,items:[]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},load:function(a){var b=this;if(a){this.messageId=a}MemberAction.findOfferById(this.messageId,function(c){var f=c.data;b.resultData=f;b.down("vipform").getForm().setValues({title:f.title,initDate:f.startDate,expireDate:f.endDate});var d=new Date();d.setHours(0);d.setMinutes(0);d.setSeconds(0);d.setMilliseconds(0);if(b.down("#initDate").getValue().getTime()>=d.getTime()){b.down("#initDate").setMinValue(d);b.down("#initDate").setReadOnly(false)}else{b.down("#initDate").setMinValue(f.initDate);b.down("#initDate").setReadOnly(true)}if(f.content.lenth){for(var e=0;e<f.content.lenth;e++){b.addDescription(f.content,"../"+f.pictureUrl)}}else{b.addDescription(f.content,"../"+f.pictureUrl)}})},choosePicture:function(){var a=this;var b=new CKFinder();b.selectActionFunction=function(c,d){a.setSrc(c)};b.popup(720,540)},addDescription:function(d,a,e){var c=this;if(a==null){a="images/default_image.png"}var b=Ext.create("Ext.form.Panel",{border:false,items:[{xtype:"fieldset",margin:"5 10",padding:"5 40",width:390,title:"描述"+c.num,items:[{xtype:"hiddenfield",value:e},{xtype:"image",name:"picture",style:"border:1px dashed #AAA;cursor:pointer",src:a,width:300,height:225,colspan:2,listeners:{afterrender:function(f){f.getEl().on("click",c.choosePicture,f)}}},{xtype:"textareafield",name:"content",itemId:"content",emptyText:"活动详情",value:d,width:300,height:100,maxLength:500,maxLengthText:"不可超过500字符",margin:"3 0 0 0",colspan:2,listeners:{change:function(i,g){var h=i.getValue().length;var f=500-h;if(f>0&&f!=500){i.nextSibling().setText("还可输入"+f+"个字符")}else{if(f==0||f==500){i.nextSibling().setText("")}else{i.nextSibling().setText("已经超出"+(-f)+"个字符")}}}}},{xtype:"label",margin:"0 100",colspan:2,style:"color:red",text:""},{xtype:"container",layout:"hbox",items:[{xtype:"button",width:140,margin:"0 20 20 0",text:"删除本描述",handler:function(g){var f=c.down("#description");if(f.items.length>1){f.remove(g.up().up())}else{Ext.Msg.error("至少添加一条描述")}}},{xtype:"button",width:140,margin:"0 0 20 0",text:"保存本描述",handler:function(g){var f=c.down("#description");if(f.items.length>1){f.remove(g.up().up())}else{Ext.Msg.error("至少添加一条描述")}}}]}]}]});c.num++;this.down("#description").add(b)},save:function(d){var g=this;var f=this.down("vipform").getForm();var c=new Array();var e=this.query("[name=picture]");for(var b=0;b<e.length;b++){if(e[b].src.indexOf("default_image.png")>=0){Ext.Msg.alert("提示","请添加"+e[b].up().title+"的图片");return}if(e[b].src&&e[b].src.indexOf("http")==-1){c[b]=window.location.protocol+"//"+window.location.host+e[b]}else{c[b]=e[b]}}if(f.isValid()){var a=f.getValues();Ext.apply(a,{messageId:this.messageId,pictureUrl:c});MemberAction.editOffer(a,function(h){if(h.success){Ext.Msg.info("修改成功.",function(){if(g.onSave){g.onSave.fn.call(g.onSave.scope)}g.destroy()})}else{Ext.Msg.error(h.message)}})}}});Ext.define("VIP.message.EditNewsWindow",{extend:Ext.window.Window,alias:["widget.editnewswindow"],icon:"images/promotion.png",layout:"fit",padding:5,title:"修改活动信息",modal:true,border:false,resizable:false,width:432,height:560,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.save()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,layout:{type:"table",columns:2},defaults:{labelWidth:60,labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:"标题",name:"title",colspan:2,width:400,maxLength:10,maxLengthText:"不可超过10字符",vtype:"stringblank",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#initDate").focus(true)}},delay:200}}},{xtype:"image",name:"picture",style:"border:1px dashed #AAA;cursor:pointer",width:400,height:300,colspan:2,listeners:{afterrender:function(c){c.getEl().on("click",b.choosePicture,b)}}},{xtype:"textareafield",name:"content",itemId:"content",emptyText:"活动详情",width:400,height:135,maxLength:500,maxLengthText:"不可超过500字符",margin:"3 0 0 0",colspan:2,listeners:{change:function(f,d){var e=f.getValue().length;var c=500-e;if(c>0&&c!=500){b.down("#lengthInfo").setText("还可输入"+c+"个字符")}else{if(c==0||c==500){b.down("#lengthInfo").setText("")}else{b.down("#lengthInfo").setText("已经超出"+(-c)+"个字符")}}}}},{xtype:"label",margin:"0 140",colspan:2,style:"color:red",itemId:"lengthInfo",text:""}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},load:function(a){var b=this;if(a){this.messageId=a}MemberAction.getVIPMessageById(this.messageId,function(c){var e=c.data;b.resultData=e;b.down("vipform").getForm().setValues({title:e.title,content:e.content});var d=b.down("image[name=picture]");d.setSrc("../"+e.pictureUrl)})},choosePicture:function(){var a=this.down("image[name=picture]");var b=new CKFinder();b.selectActionFunction=function(c,d){a.setSrc(c)};b.popup(720,540)},save:function(c){var e=this;var d=this.down("vipform").getForm();var b="";var f=this.down("[name=picture]").src+"";if(f&&f.indexOf("http")==-1){b=window.location.protocol+"//"+window.location.host+f}else{b=f}if(d.isValid()){var a=d.getValues();Ext.apply(a,{messageId:this.messageId,pictureUrl:b});MemberAction.editVIPMessage(a,function(g){if(g.success){Ext.Msg.info("修改成功.",function(){if(e.onSave){e.onSave.fn.call(e.onSave.scope)}e.destroy()})}else{Ext.Msg.error(g.message)}})}}});Ext.define("VIP.message.SendMsgWin",{extend:Ext.window.Window,alias:["widget.sendmsgwin"],layout:"fit",width:360,height:400,tel:null,ids:null,buttonAlign:"center",createView:function(){var b=this;var a=[{xtype:"form",frame:true,width:400,layout:"anchor",border:false,bodyPadding:10,fieldDefaults:{labelAlign:"top",labelWidth:100,labelStyle:"font-weight:bold"},defaults:{anchor:"100%",margins:"0 0 10 0"},items:[{xtype:"textareafield",fieldLabel:"手机号码",allowBlank:false,disabled:true,height:60,value:b.tel},{xtype:"textareafield",fieldLabel:"短信内容",labelAlign:"top",name:"content",itemId:"content",height:240,margin:"0",allowBlank:false}]}];return a},createButtons:function(){var b=this;var a=[{text:"选择模板",scale:"medium",itemId:"choose",handler:function(c){Ext.create("VIP.message.ChooseTemplate",{modal:true,frame:true,setContent:{fn:function(d){b.down("#content").setValue(b.down("#content").getValue()+d)},scope:this}}).show()}},{text:"发送",icon:"images/printer-22.png",scale:"medium",itemId:"send",handler:function(c){b.sendMsg(c)}},{text:"关闭",icon:"images/cancel-22.png",scale:"medium",itemId:"close",handler:function(c){b.close()}}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)},sendMsg:function(b){var d=this;var a=d.down("form").getValues();var c=a.content;b.disable();SMSMessageAction.broadCastingMessage({tel:d.tel,content:c,ids:d.ids},function(e){if(e.success){Ext.Msg.info("发送成功");d.down("form").getForm().reset()}});b.enable()}});Ext.define("VIP.message.model.Coupon",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"title",type:"string"},{name:"endDate",type:"string"},{name:"startDate",type:"string"},{name:"content",type:"string"},{name:"createTime",type:"string"}]});Ext.define("VIP.message.model.News",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"title",type:"string"},{name:"content",type:"string"},{name:"createTime",type:"string"}]});Ext.define("VIP.message.store.Coupon",{extend:VIP.store.BaseStore,model:"VIP.message.model.Coupon",remoteSort:true,pageSize:50,sorters:[{property:"createTime",direction:"DESC"}],pageSize:50,proxy:{type:"direct",directFn:"MemberAction.listCoupons",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.message.store.News",{extend:VIP.store.BaseStore,model:"VIP.message.model.News",remoteSort:true,pageSize:50,sorters:[{property:"createTime",direction:"DESC"}],pageSize:50,proxy:{type:"direct",directFn:"MemberAction.listVIPMessage",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.reports.ConsumeInfo",{extend:Ext.window.Window,alias:["widget.consumeinfo"],requires:[],layout:"fit",padding:5,title:"详细信息",modal:true,resizable:false,border:false,width:520,height:420,createButtons:function(){var b=this;var a=[{text:"关闭",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,layout:{type:"table",columns:2},defaults:{labelWidth:60,width:240,labelAlign:"right"},items:[{xtype:"displayfield",fieldLabel:"消费单号",itemId:"orderNumber",colspan:2},{xtype:"displayfield",fieldLabel:"会员Email",itemId:"userName"},{xtype:"displayfield",fieldLabel:"会员昵称",itemId:"userScreenName"},{xtype:"displayfield",fieldLabel:"消费内容",itemId:"consumeSubject"},{xtype:"displayfield",fieldLabel:"消费金额",itemId:"consumptionAmount"},{xtype:"displayfield",fieldLabel:"应付金额",itemId:"accountPayable"},{xtype:"displayfield",fieldLabel:"折扣金额",itemId:"discount"},{xtype:"displayfield",fieldLabel:"卡内支付",itemId:"cardPayment"},{xtype:"displayfield",fieldLabel:"现金支付",itemId:"cashPayment"},{xtype:"displayfield",fieldLabel:"消费找零",itemId:"changeAmount"},{xtype:"displayfield",fieldLabel:"卡内余额",itemId:"currentDeposit"},{xtype:"displayfield",fieldLabel:"消费时间",itemId:"time"},{xtype:"displayfield",fieldLabel:"店铺名称",itemId:"shopName"},{xtype:"displayfield",fieldLabel:"操作人员",itemId:"operatorName",colspan:2},{xtype:"textareafield",fieldLabel:"消费备注",itemId:"notes",height:80,width:405,readOnly:true,colspan:2}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},load:function(){var a=this;a.down("#accountPayable").setValue(this.params.record.accountPayable);a.down("#cardPayment").setValue(this.params.record.cardPayment);a.down("#cashPayment").setValue(this.params.record.cashPayment);a.down("#changeAmount").setValue(this.params.record.changeAmount);a.down("#consumeSubject").setValue(this.params.record.consumeSubject);a.down("#currentDeposit").setValue(this.params.record.currentDeposit);a.down("#discount").setValue(this.params.record.discount);a.down("#notes").setValue(this.params.record.notes);a.down("#operatorName").setValue(this.params.record.operatorName);a.down("#orderNumber").setValue(this.params.record.orderNumber);a.down("#shopName").setValue(this.params.record.shopName);a.down("#time").setValue(this.params.record.time);a.down("#userName").setValue(this.params.record.userName);a.down("#userScreenName").setValue(this.params.record.userScreenName);a.down("#consumptionAmount").setValue(this.params.record.consumptionAmount)}});Ext.define("VIP.reports.DepositInfo",{extend:Ext.window.Window,alias:["widget.depositinfo"],requires:[],layout:"fit",padding:5,title:"详细信息",modal:true,resizable:false,border:false,width:520,height:360,createButtons:function(){var b=this;var a=[{text:"关闭",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,layout:{type:"table",columns:2},defaults:{labelWidth:60,width:240,labelAlign:"right"},items:[{xtype:"displayfield",fieldLabel:"存款单号",itemId:"orderNumber",colspan:2},{xtype:"displayfield",fieldLabel:"会员Email",itemId:"userName"},{xtype:"displayfield",fieldLabel:"会员昵称",itemId:"userScreenName"},{xtype:"displayfield",fieldLabel:"充值金额",itemId:"realAmount"},{xtype:"displayfield",fieldLabel:"赠送金额",itemId:"rewardAmount"},{xtype:"displayfield",fieldLabel:"充值时间",itemId:"time"},{xtype:"displayfield",fieldLabel:"会员余额",itemId:"currentDeposit"},{xtype:"displayfield",fieldLabel:"充值店铺",itemId:"shopName"},{xtype:"displayfield",fieldLabel:"操作人员",itemId:"operatorName"},{xtype:"textareafield",fieldLabel:"充值备注",itemId:"notes",height:80,width:405,readOnly:true,colspan:2}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},load:function(){var a=this;a.down("#userScreenName").setValue(this.params.record.userScreenName);a.down("#userName").setValue(this.params.record.userName);a.down("#operatorName").setValue(this.params.record.operatorName);a.down("#shopName").setValue(this.params.record.shopName);a.down("#orderNumber").setValue(this.params.record.orderNumber);a.down("#realAmount").setValue(this.params.record.realAmount);a.down("#rewardAmount").setValue(this.params.record.rewardAmount);a.down("#time").setValue(this.params.record.time);a.down("#currentDeposit").setValue(this.params.record.currentDeposit);a.down("#notes").setValue(this.params.record.notes)}});Ext.define("VIP.reports.WithdrawInfo",{extend:Ext.window.Window,alias:["widget.withdrawinfo"],requires:[],layout:"fit",padding:5,title:"详细信息",modal:true,resizable:false,border:false,width:520,height:360,createButtons:function(){var b=this;var a=[{text:"关闭",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",bodyPadding:10,layout:{type:"table",columns:2},defaults:{labelWidth:60,width:240,labelAlign:"right"},items:[{xtype:"displayfield",fieldLabel:"取款单号",itemId:"orderNumber",colspan:2},{xtype:"displayfield",fieldLabel:"会员Email",itemId:"userName"},{xtype:"displayfield",fieldLabel:"会员昵称",itemId:"userScreenName"},{xtype:"displayfield",fieldLabel:"取款金额",itemId:"amount"},{xtype:"displayfield",fieldLabel:"取款时间",itemId:"time"},{xtype:"displayfield",fieldLabel:"卡内余额",itemId:"currentDeposit"},{xtype:"displayfield",fieldLabel:"取款时间",itemId:"time"},{xtype:"displayfield",fieldLabel:"店铺名称",itemId:"shopName"},{xtype:"displayfield",fieldLabel:"操作人员",itemId:"operatorName",colspan:2},{xtype:"textareafield",fieldLabel:"取款备注",itemId:"notes",height:80,width:405,readOnly:true,colspan:2}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load()},load:function(){var a=this;a.down("#userScreenName").setValue(this.params.record.userScreenName);a.down("#userName").setValue(this.params.record.userName);a.down("#operatorName").setValue(this.params.record.operatorName);a.down("#shopName").setValue(this.params.record.shopName);a.down("#orderNumber").setValue(this.params.record.orderNumber);a.down("#amount").setValue(this.params.record.amount);a.down("#time").setValue(this.params.record.time);a.down("#currentDeposit").setValue(this.params.record.currentDeposit);a.down("#notes").setValue(this.params.record.notes)}});Ext.define("VIP.reports.model.MemberInfo",{extend:Ext.data.Model,fields:[{name:"id",type:"string"},{name:"userId",type:"string"},{name:"userName",type:"string"},{name:"cardTypeName",type:"string"},{name:"operatorName",type:"string"},{name:"shopName",type:"string"},{name:"quickShoppingDiscountRatePercent",type:"string"},{name:"currentDeposit",type:"string"},{name:"arrears",type:"string"},{name:"lastConsumeDate",type:"string"},{name:"mobile",type:"string"},{name:"birthday",type:"string"},{name:"sex",type:"string"},{name:"password",type:"string"},{name:"sendsDate",type:"string"},{name:"expireDate",type:"string"},{name:"credentialType",type:"string"},{name:"credentialId",type:"string"},{name:"introducerCardId",type:"string"},{name:"telephone",type:"string"},{name:"email",type:"string"},{name:"address",type:"string"},{name:"organization",type:"string"},{name:"notes",type:"string"},{name:"lastUpdateTime",type:"string"},{name:"state",type:"string"}]});Ext.define("VIP.reports.store.DepositHistory",{extend:VIP.store.BaseStore,model:"VIP.reports.model.DepositHistory",remoteSort:true,pageSize:50,sorters:[{property:"time",direction:"DESC"}],proxy:{type:"direct",directFn:"DepositAction.list",reader:{type:"json",root:"records"}}});Ext.define("VIP.reports.store.IntegralHistory",{extend:VIP.store.BaseStore,model:"VIP.reports.model.IntegralHistory",remoteSort:true,pageSize:50,sorters:[{property:"time",direction:"DESC"}],proxy:{type:"direct",directFn:"DepositAction.list",reader:{type:"json",root:"records"}}});Ext.define("VIP.reports.store.WithdrawHistory",{extend:VIP.store.BaseStore,model:"VIP.reports.model.WithdrawHistory",remoteSort:true,pageSize:50,sorters:[{property:"time",direction:"DESC"}],proxy:{type:"direct",directFn:"WithdrawAction.list",reader:{type:"json",root:"records"}}});Ext.define("VIP.search.MemberGrid",{extend:VIP.member.MemberGrid,alias:["widget.searchmembergrid"],initComponent:function(){this.on("itemdblclick",this.onRecordSelect.fn,this.onRecordSelect.scope);this.on("selectionchange",this.onSelectChange.fn,this.onSelectChange.scope);this.callParent(arguments)},doQuery:function(a){var c=this.getStore().getProxy().extraParams;var b=this;if(!c){c={};this.getStore().getProxy().extraParams=c}if(a.userId!=""){c.userId=a.userId}else{c.userId=undefined}if(a.userScreenName!=""){c.accountName=a.userScreenName}else{c.accountName=undefined}if(a.telephone!=""){c.telephone=a.telephone}else{c.telephone=undefined}this.getStore().loadPage(1)}});Ext.define("VIP.search.MemberInfo",{extend:Ext.panel.Panel,alias:["widget.searchmemberinfo"],userId:null,createView:function(){var b=this;var c=this.up();var a=[{border:false,layout:{type:"hbox",align:"stretch"},items:[{margin:"10 0 0 120",xtype:"radiofield",name:"type",checked:true,inputValue:true,handler:function(e,d){var f=b.up();if(d==true){b.down("#info").hide();f.setSize(500,160);b.down("#number").show();b.focus();f.down("#search").setDisabled(true)}}},{xtype:"label",text:"二维码扫描",margin:"13 0 0 10"},{margin:"10 0 0 40",xtype:"radiofield",name:"type",inputValue:false,handler:function(e,d){var f=b.up();if(d==true){b.down("#number").hide();f.setSize(500,500);b.down("#info").show();b.typeFocus()}}},{xtype:"label",text:"手动查询",margin:"13 0 0 10"}]},{xtype:"panel",layout:{type:"vbox",align:"stretch"},itemId:"info",hidden:true,border:false,items:[{xtype:"form",width:"100%",height:120,layout:"fit",border:false,items:[{xtype:"fieldset",title:"查询条件",margin:5,defaults:{xtype:"textfield",labelAlign:"right",labelWidth:80,selectOnFocus:true,width:300},layout:{type:"vbox",align:"stretch"},items:[{fieldLabel:"会员昵称",emptyText:"会员昵称",name:"userScreenName",itemId:"userScreenName",listeners:{specialKey:{fn:function(j,g,h){if(g.keyCode==13){var d=this.up("searchmemberinfo");var f=d.down("searchmembergrid");var i=d.down("form").getForm();var e=i.getValues();f.getSelectionModel().deselectAll();f.doQuery(e)}},delay:200}}},{fieldLabel:"会员手机号",emptyText:"会员手机号",name:"telephone",itemId:"telephone",regex:/^1[3|4|5|8][0-9]{9}$/,regexText:"无效的手机号码",listeners:{specialKey:{fn:function(j,g,h){if(g.keyCode==13){var d=this.up("searchmemberinfo");var f=d.down("searchmembergrid");var i=d.down("form").getForm();var e=i.getValues();f.getSelectionModel().deselectAll();f.doQuery(e)}},delay:200}}},{xtype:"button",icon:"images/search.png",width:120,margin:"5 0 0 0",scale:"medium",text:"查询",handler:function(g){var d=this.up("searchmemberinfo");var f=d.down("searchmembergrid");var h=d.down("form").getForm();var e=h.getValues();f.getSelectionModel().deselectAll();f.doQuery(e)}}]}]},{xtype:"searchmembergrid",height:280,onRecordSelect:{fn:b.onRecordSelect,scope:b},onSelectChange:{fn:b.onSelectChange,scope:b}}]},{xtype:"panel",layout:{type:"vbox",align:"stretch"},itemId:"number",hidden:false,border:false,items:[{xtype:"fieldset",title:"二维码身份识别",margin:5,defaults:{xtype:"textfield",labelAlign:"right",labelWidth:80,selectOnFocus:true,width:300},layout:{type:"vbox",align:"stretch"},items:[{fieldLabel:"会员二维码",emptyText:"请扫描会员身份二维码",name:"qrString",itemId:"qrString",inputType:"password",listeners:{specialKey:{fn:function(f,d,e){if(d.keyCode==13){b.onPasswordSelect()}},delay:200}}}]}]}];return a},focus:function(){var a=this;setTimeout(function(){a.down("#qrString").focus(true)},500)},typeFocus:function(){var a=this;setTimeout(function(){a.down("#userScreenName").focus(true)},500)},initComponent:function(){Ext.apply(this,{items:this.createView()});this.callParent(arguments);this.focus()},onRecordSelect:function(c,a,b){var e=this.ownerCt;var d=a.data;e.onRecordSelect.fn.call(e.onRecordSelect.scope,d.userId,false);e.close()},onSelectChange:function(b,c,a){var d=this.ownerCt;if(c.length!=0){this.userId=c[0].data.userId;d.down("#search").setDisabled(false)}},onPasswordSelect:function(){var b=this.ownerCt;var a=this;value=this.down("#qrString").getValue();MemberAction.getMemberByQRString(value,function(c){if(c.success){var d=c.data;b.onRecordSelect.fn.call(b.onRecordSelect.scope,d._id,!d.type,value);b.close()}else{Ext.Msg.error(c.message,function(){a.down("#qrString").setValue();a.focus()})}})},doSelect:function(){var a=this.ownerCt;a.onRecordSelect.fn.call(a.onRecordSelect.scope,this.userId,false);a.close()}});Ext.define("VIP.search.SearchMember",{extend:Ext.window.Window,alias:["widget.serchmember"],title:"会员查询",modal:true,frame:true,resizable:false,width:500,height:160,y:120,icon:"images/search-16.png",layout:"fit",createView:function(){var b=this;var a=[{xtype:"searchmemberinfo",border:false}];return a},createButtons:function(){var b=this;var a=[{text:"选择",icon:"images/update.png",itemId:"search",disabled:true,handler:function(c){var d=b.down("searchmemberinfo");d.doSelect(c)}},{text:"取消",icon:"images/cancel.png",handler:function(c){b.destroy()}}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)}});Ext.define("VIP.security.OperatorRuleWindow",{extend:Ext.window.Window,alias:["widget.operatorrulewindow"],layout:"fit",width:680,height:540,title:"",icon:"images/manage_role.png",modal:true,border:false,resizable:false,params:{},createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){if(b.params.ruleId!=undefined){b.saveRule()}else{b.addRule()}}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 30%",defaults:{width:500,labelAlign:"right"},layout:{type:"table",columns:1},items:[{xtype:"textfield",fieldLabel:"名称",name:"name",itemId:"name",vtype:"stringblank",maxLength:"15",maxLengthText:"不可超过15位",allowBlank:false,listeners:{specialKey:{fn:function(e,c,d){if(c.keyCode==13){b.down("#description").focus(true)}},delay:200}}},{xtype:"textarea",fieldLabel:"描述",name:"description",itemId:"description",maxLength:"140",maxLengthText:"不可超过140位",allowBlank:false}]},{xtype:"fieldset",title:"操作权限",itemId:"actions_fieldset",autoScroll:true,anchor:"100% 70%",padding:"5 10 10 40",layout:{type:"vbox",align:"stretch"},fieldDefaults:{labelWidth:100},items:[{xtype:"checkbox",boxLabel:"全选",listeners:{change:{fn:this.selectAll,scope:this}}}]}]}];return a},initComponent:function(){var a=this;Ext.apply(this,{title:this.params.ruleId?"修改权限组":"添加权限组",items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.load();setTimeout(function(){a.down("#name").focus(true)},500)},load:function(){var a=this;OperatorRuleAction.listAllActions({},function(b){a.actions=b.records;a.fillActions()})},fillActions:function(){var e=this;var b=this.down("#actions_fieldset");b.suspendLayout=true;for(var a=0;a<this.actions.length;a++){var d=this.actions[a];var c=b.down("checkboxgroup[fieldLabel="+d.category+"]");if(!c){c=Ext.create("Ext.form.CheckboxGroup",{fieldLabel:d.category,columns:3,vertical:true,margin:"5 20 20 0",labelStyle:"font-weight:bold",style:{borderBottom:"1px solid gray"}});b.add(c)}c.add({name:"actions",inputValue:d.id,boxLabel:d.name})}b.suspendLayout=false;b.doLayout();if(this.params.ruleId){OperatorRuleAction.get({ruleId:this.params.ruleId},function(g){if(g.success){var f=g.data;e.down("vipform").getForm().setValues({name:f.name,actions:f.actions.split(","),description:f.description})}else{Ext.Msg.error(g.message)}})}},selectAll:function(c,b){var d=this.query("checkbox[name=actions]");for(var a=0;a<d.length;a++){d[a].setValue(b==true)}},addRule:function(b){var d=this;var c=this.down("vipform").getForm();if(c.isValid()){var a=c.getValues();OperatorRuleAction.addRule(Ext.apply({},a),function(e){if(e.success){Ext.Msg.info("添加成功",function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.destroy()})}else{Ext.Msg.error(e.message)}})}},saveRule:function(b){var d=this;var c=this.down("vipform").getForm();if(c.isValid()){var a=c.getValues();OperatorRuleAction.editRule(Ext.apply({ruleId:this.params.ruleId},a),function(e){if(e.success){Ext.Msg.info("修改成功",function(){if(d.onSave){d.onSave.fn.call(d.onSave.scope)}d.destroy()})}else{Ext.Msg.error(e.message)}})}}});Ext.define("VIP.sms.EditConsumeSMS",{extend:Ext.window.Window,alias:["widget.editconsumesms"],layout:"fit",width:640,height:400,title:"消费短信模板",modal:true,border:false,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/ok-16.png",width:90,handler:function(c){b.onSave.fn.call(b.onSave.scope)}},{text:"取消",icon:"images/cancel-16.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 75%",defaults:{columnWidth:0.25,margin:"5 5 5 5"},layout:"column",items:[{xtype:"label",text:"字段编码"},{xtype:"label",text:"代表内容"},{xtype:"label",text:"字段编码"},{xtype:"label",text:"代表内容"},{xtype:"label",text:"[$orderNumber$]"},{xtype:"label",text:"订单号"},{xtype:"label",text:"[$userId$]"},{xtype:"label",text:"卡号"},{xtype:"label",text:"[$userName$]"},{xtype:"label",text:"会员姓名"},{xtype:"label",text:"[$consumeSubject$]"},{xtype:"label",text:"消费内容"},{xtype:"label",text:"[$time$]"},{xtype:"label",text:"时间"},{xtype:"label",text:"[$accountPayable$]"},{xtype:"label",text:"应付金额"},{xtype:"label",text:"[$point$]"},{xtype:"label",text:"获得积分"},{xtype:"label",text:"[$cashPayment$]"},{xtype:"label",text:"现金支付"},{xtype:"label",text:"[$bankCardPaymant$]"},{xtype:"label",text:"银行卡支付"},{xtype:"label",text:"[$cardPayment$]"},{xtype:"label",text:"会员卡支付"},{xtype:"label",text:"[$totalPayment$]"},{xtype:"label",text:"总支付"},{xtype:"label",text:"[$changeAmount$]"},{xtype:"label",text:"找零"},{xtype:"label",text:"[$currentDeposit$]"},{xtype:"label",text:"当前余额"},{xtype:"label",text:"[$operatorName$]"},{xtype:"label",text:"操作员"},{xtype:"label",text:"[$shopName$]"},{xtype:"label",text:"消费店铺"}]},{xtype:"form",anchor:"100% 25%",layout:"anchor",items:[{xtype:"textareafield",grow:true,name:"content",allowBlank:false,anchor:"100% 100%"}]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.onLoad.fn.call(this.onLoad.scope)}});Ext.define("VIP.sms.EditDepositSMS",{extend:Ext.window.Window,alias:["widget.editdepositsms"],layout:"fit",width:640,height:400,title:"充值短信模板",modal:true,border:false,createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/ok-16.png",width:90,handler:function(c){b.onSave.fn.call(b.onSave.scope)}},{text:"取消",icon:"images/cancel-16.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"基本信息",anchor:"100% 75%",defaults:{columnWidth:0.25,margin:"5 5 5 5"},layout:"column",items:[{xtype:"label",text:"字段编码"},{xtype:"label",text:"代表内容"},{xtype:"label",text:"字段编码"},{xtype:"label",text:"代表内容"},{xtype:"label",text:"[$userId$]"},{xtype:"label",text:"卡号"},{xtype:"label",text:"[$userName$]"},{xtype:"label",text:"会员姓名"},{xtype:"label",text:"[$realAmount$]"},{xtype:"label",text:"充值金额"},{xtype:"label",text:"[$time$]"},{xtype:"label",text:"时间"},{xtype:"label",text:"[$rewardAmount$]"},{xtype:"label",text:"赠送金额"},{xtype:"label",text:"剩余积分"},{xtype:"label",text:"[$currentDeposit$]"},{xtype:"label",text:"当前余额"},{xtype:"label",text:"[$operatorName$]"},{xtype:"label",text:"操作员"},{xtype:"label",text:"[$shopName$]"},{xtype:"label",text:"消费店铺"}]},{xtype:"form",anchor:"100% 25%",layout:"anchor",items:[{xtype:"textareafield",grow:true,name:"content",allowBlank:false,anchor:"100% 100%"}]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments);this.onLoad.fn.call(this.onLoad.scope)}});Ext.define("VIP.sms.model.MessageHistory",{extend:Ext.data.Model,fields:[{name:"targetNumber",type:"string"},{name:"content",type:"string"},{name:"time",type:"string"},{name:"operatorName",type:"string"},{name:"shopName",type:"string"}]});Ext.define("VIP.sms.store.MessageHistory",{extend:VIP.store.BaseStore,model:"VIP.sms.model.MessageHistory",remoteSort:true,pageSize:50,sorters:[{property:"time",direction:"DESC"}],proxy:{type:"direct",directFn:"MessageAction.list",reader:{type:"json",root:"records"}},autoLoad:true});Ext.define("VIP.system.DeleteMembershipTypeWindow",{extend:Ext.window.Window,alias:["widget.deletemembershiptypewindow"],layout:"fit",width:640,height:280,title:"删除卡片",modal:true,resizable:false,border:false,icon:"images/level_management.png",createView:function(){},createButtons:function(){var b=this;var a=[{text:"保存",icon:"images/update.png",width:90,handler:function(c){b.saveMembershipType()}},{text:"取消",icon:"images/cancel.png",width:90,handler:function(c){b.destroy()}}];return a},createView:function(){var b=this;var a=[{xtype:"vipform",defaults:{margin:5},layout:{type:"anchor"},items:[{xtype:"fieldset",title:"提示信息",anchor:"100% 100%",defaults:{width:275,labelAlign:"right"},layout:{type:"table",columns:2},items:[{xtype:"label",fieldLabel:"类别名称",text:"该会员等级下,共拥有会员"+b.params.membershipNumber+"人,请将他们转移至其他会员等级",padding:"10 10 10 20"},{xtype:"vcombo",labelWidth:63,width:183,itemId:"membershipTypeId",value:"",allowBlank:false,getProxy:function(){return{type:"direct",directFn:"MembershipTypeAction.listAsOptionByDelete",reader:{type:"json",root:"records"},extraParams:{membetshipTypeId:b.params.membershipTypeId}}}}]}]}];return a},initComponent:function(){Ext.apply(this,{items:this.createView(),buttons:this.createButtons()});this.callParent(arguments)},addListeners:function(){},saveMembershipType:function(a){var c=this;var b=this.down("vipform").getForm();if(b.isValid()){var d=c.down("#membershipTypeId").getValue();MembershipTypeAction.deleteMembershipTypeById(c.params.membershipTypeId,d,function(e){if(e.success){if(c.onSave){c.onSave.fn.call(c.onSave.scope)}c.destroy()}else{Ext.Msg.error(e.message)}})}}});